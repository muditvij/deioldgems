<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlmaLink - DEI Agra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
:root{--primary-color:#4f46e5;--primary-hover:#4338ca;--secondary-color:#f59e0b;--background-color:#f8f9fa;--text-color:#111827;--card-bg:#ffffff;--quote-color:#4b5563;--border-color:#e5e7eb}
body{font-family:'Manrope',sans-serif;background-color:var(--background-color);color:var(--text-color);overflow-x:hidden}
.page{animation:fadeInUp .6s ease-in-out}
@keyframes fadeInUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
.btn-primary{background-color:var(--primary-color);color:white;transition:all .3s ease;box-shadow:0 4px 6px rgba(79,70,229,.1)}
.btn-primary:hover{background-color:var(--primary-hover);transform:translateY(-2px);box-shadow:0 7px 14px rgba(79,70,229,.2)}
.input-field{transition:all .3s ease;border-color:var(--border-color)}
.input-field:focus{border-color:var(--primary-color);box-shadow:0 0 0 3px rgba(79,70,229,.2);outline:none}
.card{background-color:var(--card-bg);border-radius:16px;box-shadow:0 4px 12px rgba(0,0,0,.05);transition:transform .3s ease,box-shadow .3s ease,border-color .3s ease;border:1px solid var(--border-color)}
.card:hover{transform:translateY(-5px);box-shadow:0 12px 24px rgba(0,0,0,.1);border-color:var(--primary-color)}
.modal-backdrop{position:fixed;top:0;left:0;width:100%;height:100%;background-color:rgba(17,24,39,.6);display:flex;justify-content:center;align-items:center;z-index:50;backdrop-filter:blur(5px);animation:fadeIn .3s ease}
.modal-content{background:white;padding:2.5rem;border-radius:16px;width:90%;max-width:600px;animation:scaleUp .3s ease-in-out;box-shadow:0 25px 50px -12px rgba(0,0,0,.25);max-height:90vh;overflow-y:auto}
#search-results,#search-results-mobile{position:absolute;width:100%;z-index:10;max-height:300px;overflow-y:auto;border-radius:8px;border:1px solid var(--border-color);box-shadow:0 10px 15px -3px rgba(0,0,0,.1)}
@keyframes scaleUp{from{opacity:0;transform:scale(.95)}to{opacity:1;transform:scale(1)}}
#app-loader{transition:opacity .5s ease}
#app-loader.fade-out{opacity:0}
.loader-logo{animation:scaleIn .7s cubic-bezier(.16,1,.3,1) forwards}
.loader-text{animation:fadeInUp .7s .2s cubic-bezier(.16,1,.3,1) forwards;opacity:0}
.loader-quote{animation:fadeInUp .7s .4s cubic-bezier(.16,1,.3,1) forwards;opacity:0}
.loader-spinner{animation:fadeInUp .7s .6s cubic-bezier(.16,1,.3,1) forwards,spin 1s linear infinite;opacity:0}
@keyframes scaleIn{from{transform:scale(.8);opacity:0}to{transform:scale(1);opacity:1}}
.skeleton-loader{background-color:#e5e7eb;border-radius:8px;animation:pulse 1.5s cubic-bezier(.4,0,.6,1) infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}
#alumni-data-table th,#alumni-data-table td{padding:12px 15px;text-align:left}
.saarthi-bg{background:linear-gradient(135deg,rgba(79,70,229,.9),rgba(124,58,237,.9)),url('https://placehold.co/1920x1080/0d9488/0f766e/png?text=.') no-repeat center center;background-size:cover}
.chat-bubble-user{background-color:var(--primary-color);color:white}
.chat-bubble-model{background-color:#e5e7eb;color:var(--text-color)}
.typing-indicator span{height:8px;width:8px;background-color:var(--primary-color);border-radius:50%;display:inline-block;animation:bounce 1.4s infinite ease-in-out both}
.typing-indicator span:nth-child(1){animation-delay:-.32s}
.typing-indicator span:nth-child(2){animation-delay:-.16s}
@keyframes bounce{0%,80%,100%{transform:scale(0)}40%{transform:scale(1)}}
@keyframes blink{50%{opacity:0}}
.badge-new{animation:blink 1.5s linear infinite;background-color:#ef4444;color:white}
nav{border-bottom:1px solid var(--border-color)}
.nav-link.active{color:var(--primary-color);font-weight:600;border-bottom:2px solid var(--primary-color)}
    </style>
</head>
<body class="antialiased">

    <!-- App Loader: This shows while the application initializes -->
    <div id="app-loader" class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[100] text-center px-4">
        <img src="logo.png" alt="DEI Logo" class="w-24 h-24 mb-4 rounded-full loader-logo">
        <h1 class="text-3xl font-bold text-gray-800 loader-text">AlmaLink DEI</h1>
        <p id="loader-quote" class="mt-4 text-lg text-[var(--quote-color)] loader-quote"></p>
        <div class="mt-8 border-gray-300 h-8 w-8 animate-spin rounded-full border-4 border-t-[var(--primary-color)] loader-spinner"></div>
    </div>

    <!-- Main App Container: All pages will be rendered inside this div -->
    <div id="app-container" class="min-h-screen"></div>
    
    <!-- Modal Container: Used for pop-ups like user profiles, job postings, etc. -->
    <div id="modal-container"></div>

    <script type="module">
        // Firebase and Application Logic
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, deleteUser, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, addDoc, serverTimestamp, orderBy, updateDoc, arrayUnion, arrayRemove, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyD5KFbouIqFTkzeHGL3IGavdGLM3OjwWBI",
            authDomain: "deioldgems.firebaseapp.com",
            projectId: "deioldgems",
            storageBucket: "deioldgems.firebasestorage.app",
            messagingSenderId: "933183653419",
            appId: "1:933183653419:web:9ba92d801f60aa68c78c6e",
            measurementId: "G-3J4YDNM1MY"
        };

        const GEMINI_API_KEY = "AIzaSyDgHqrrTXR8apwWUxJSomJgw-BODNFoC-E";
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "alumnideiagra";
        setPersistence(auth, browserLocalPersistence);

        const adminEmails = ["admin@dei.com"];
        const state = { currentUser: null, userData: null, users: [], jobs: [], events: [], chatMessages: [], currentPage: 'loading', viewingProfile: null, isDataLoading: true, isAdmin: false, alumniYearData: [], MargdarshakHistory: [], isAiResponding: false };
        const quotes = ["Connecting roots, growing futures.", "From classrooms to careers, our bond remains.", "Mentorship is the bridge between experience and aspiration."];
        const deiCourses = { "Faculty of Engineering": ["B.Tech. Electrical Engineering", "B.Tech. Mechanical Engineering", "B.Tech. Civil Engineering", "B.Tech. Computer Science", "B.Tech. Footwear Technology"], "Faculty of Science": ["B.Sc. (Hons.) Mathematics", "B.Sc. (Hons.) Physics", "B.Sc. (Hons.) Chemistry", "B.Sc. (Hons.) Computer Science", "B.Sc. (Hons.) Zoology", "B.Sc. (Hons.) Botany"], "Faculty of Arts": ["B.A. (Hons.) English", "B.A. (Hons.) Hindi", "B.A. (Hons.) Music", "B.A. (Hons.) Drawing & Painting", "B.A. (Hons.) Home Science"], "Faculty of Commerce": ["B.Com. (Hons.)", "M.Com."], "Faculty of Social Science": ["B.A. (Hons.) Political Science", "B.A. (Hons.) Sociology", "B.A. (Hons.) Psychology", "B.A. (Hons.) Economics"], "Faculty of Architecture": ["B.Arch."] };
        const inappropriateWords = ["abuse", "idiot", "stupid", "hate", "kill", "dumb", "fool"];
        const recruiterVerificationCodes = ["DEI-RC-A8F2", "DEI-RC-9G3H", "DEI-RC-B4K5", "DEI-RC-C1L9", "DEI-RC-D7M3"];
        
        const dom = { appContainer: document.getElementById('app-container'), appLoader: document.getElementById('app-loader'), modalContainer: document.getElementById('modal-container'), loaderQuote: document.getElementById('loader-quote') };

        const utils = {
            showToast: (message, type = 'success') => { const toast = document.createElement('div'); toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-2xl z-[101] animate-fadeIn ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.style.animation = 'fadeOut 0.5s'; setTimeout(() => toast.remove(), 500); }, 3000); },
            getProfileImageUrl: (user) => { if (user) { const baseUrl = 'https://firebasestorage.googleapis.com/v0/b/deioldgems.appspot.com/o/'; const token = '&token=658dfb61-4091-4993-9c88-594364278474'; if (user.role === 'Student') return user.gender === 'Male' ? `male1.jpg` : `female1.jpg`; if (user.role === 'Alumni') return user.gender === 'Male' ? `male2.jpg` : `female2.jpg`; if (user.role === 'Recruiter') return `recruiter.jpg`; if (user.role === 'Admin') return `https://placehold.co/100x100/4f46e5/ffffff?text=ADM`; } return 'https://placehold.co/100x100/E0E7FF/4338CA?text=?'; },
            getRandomQuote: () => quotes[Math.floor(Math.random() * quotes.length)],
            populateCourses: (faculty, courseElementId, selectedCourse = '') => { const courseSelect = document.getElementById(courseElementId); if (!courseSelect) return; courseSelect.innerHTML = '<option value="">Select Course</option>'; if (faculty && deiCourses[faculty]) { deiCourses[faculty].forEach(course => { const option = document.createElement('option'); option.value = course; option.textContent = course; if (course === selectedCourse) option.selected = true; courseSelect.appendChild(option); }); courseSelect.disabled = false; } else { courseSelect.disabled = true; } },
            getRoleBadge: (role) => { const roles = { 'Student': 'bg-blue-100 text-blue-800', 'Alumni': 'bg-green-100 text-green-800', 'Recruiter': 'bg-purple-100 text-purple-800', 'Admin': 'bg-yellow-100 text-yellow-800' }; return `<span class="text-xs font-medium ml-2 px-2 py-0.5 rounded-full ${roles[role] || ''}">${role}</span>`; },
            getMentorBadge: (givenCount = 0) => { if(givenCount < 5) return ''; const badges = [{t:100, n:'üíé Diamond Mentor', c:'bg-cyan-100 text-cyan-800'},{t:50, n:'‚ú® Platinum Mentor', c:'bg-gray-200 text-gray-800'},{t:20, n:'‚≠ê Gold Mentor', c:'bg-amber-100 text-amber-800'},{t:10, n:'ü•à Silver Mentor', c:'bg-slate-200 text-slate-700'},{t:5, n:'ü•â Bronze Mentor', c:'bg-orange-200 text-orange-800'}]; const badge = badges.find(b => givenCount >= b.t); return badge ? `<span class="text-xs font-bold ml-2 px-2.5 py-1 rounded-full ${badge.c}">${badge.n}</span>` : ''; }
        };

        const render = {
            navbar: () => { if (!state.currentUser || !state.userData) return ''; const links = [ { page: 'dashboard', text: 'Dashboard', roles: ['Student', 'Alumni', 'Recruiter', 'Admin'] }, { page: 'alumniData', text: 'Alumni Data', roles: ['Student', 'Alumni', 'Recruiter', 'Admin'] }, { page: 'MargdarshakAi', text: 'Margdarshak AI', roles: ['Student', 'Alumni', 'Recruiter', 'Admin'], isNew: true }, { page: 'jobs', text: 'Job Board', roles: ['Student', 'Alumni'] }, { page: 'profile', text: 'Profile', roles: ['Student', 'Alumni', 'Recruiter', 'Admin'] }, { page: 'chat', text: 'Chat', roles: ['Student', 'Alumni', 'Recruiter', 'Admin'] }, { page: 'admin', text: 'Admin Panel', roles: ['Admin'] } ]; const navLinks = (isMobile) => links.filter(l => l.roles.includes(state.userData.role)).map(l => `<button data-page="${l.page}" class="${isMobile ? 'nav-link-mobile block w-full text-left' : 'nav-link'} ${state.currentPage === l.page ? 'active' : ''} px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 relative">${l.text}${l.isNew ? '<span class="ml-2 absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 bg-red-500 rounded-full text-xs font-bold text-white badge-new">NEW</span>' : ''}</button>`).join(''); return `<nav class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-40"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center justify-between h-20"><div class="flex items-center"><div class="flex-shrink-0"><img src="logo.png" alt="Logo" class="w-12 h-12 rounded-full"></div><span class="ml-4 font-extrabold text-2xl text-gray-800">AlmaLink</span></div><div class="hidden md:flex items-center space-x-2"><div class="relative flex-1 max-w-sm"><input id="search-bar" type="text" placeholder="Search users..." class="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 input-field" autocomplete="off"><svg class="w-5 h-5 text-gray-400 absolute left-3 top-1/2 -translate-y-1/2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg><div id="search-results" class="hidden absolute mt-2 w-full bg-white rounded-md shadow-lg overflow-hidden"></div></div>${navLinks(false)}<button id="logout-btn" class="btn-primary px-5 py-2 rounded-full text-sm font-medium">Logout</button></div><div class="md:hidden"><button id="mobile-menu-btn" class="text-gray-700 hover:text-indigo-600 p-2 rounded-md"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button></div></div></div><div id="mobile-menu" class="md:hidden hidden bg-white border-t"><div class="px-2 pt-2 pb-3 space-y-1 sm:px-3"><div class="relative w-full p-2"><input id="search-bar-mobile" type="text" placeholder="Search users..." class="w-full px-4 py-2 rounded-md border border-gray-300 input-field" autocomplete="off"><div id="search-results-mobile" class="hidden absolute mt-1 w-full bg-white rounded-md shadow-lg overflow-hidden"></div></div>${navLinks(true)}<button id="logout-btn-mobile" class="mt-2 w-full text-left btn-primary px-3 py-2 rounded-md text-base font-medium">Logout</button></div></div></nav>`; },
            authPage: (isLogin) => { const title = isLogin ? "Welcome Back!" : "Create Your Account"; const subtext = isLogin ? "Sign in to continue your journey with AlmaLink." : "Join our vibrant community of DEI professionals."; const forgotPasswordLink = isLogin ? `<div class="text-sm text-right"><button id="forgot-password-btn" class="font-medium text-indigo-600 hover:text-indigo-500">Forgot password?</button></div>` : ''; return `<div class="page min-h-screen grid grid-cols-1 lg:grid-cols-2"><div class="flex flex-col items-center justify-center bg-indigo-50 text-gray-800 p-12 text-center relative overflow-hidden"><div class="absolute -top-20 -left-20 w-72 h-72 bg-indigo-200 rounded-full opacity-50"></div><div class="absolute -bottom-24 -right-12 w-80 h-80 bg-indigo-200 rounded-full opacity-50"></div><img src="logo.png" alt="Logo" class="w-24 h-24 rounded-full mb-6 z-10"><h1 class="text-4xl font-extrabold mb-4 z-10">AlmaLink DEI</h1><p class="text-lg text-indigo-700 z-10">"${utils.getRandomQuote()}"</p></div><div class="flex items-center justify-center bg-gray-50"><div class="max-w-md w-full space-y-8 p-10 bg-white rounded-xl shadow-lg"><div class="text-center"><h2 class="text-3xl font-extrabold text-gray-900">${title}</h2><p class="mt-2 text-sm text-gray-600">${subtext}</p></div><form id="${isLogin ? 'login' : 'signup'}-form" class="mt-8 space-y-6"><div class="rounded-md shadow-sm -space-y-px"><div><input id="${isLogin ? 'login' : 'signup'}-email" type="email" autocomplete="email" required class="appearance-none rounded-t-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none input-field sm:text-sm" placeholder="Email address"></div><div><input id="${isLogin ? 'login' : 'signup'}-password" type="password" autocomplete="current-password" required class="appearance-none rounded-b-md relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 focus:outline-none input-field sm:text-sm" placeholder="Password"></div></div>${forgotPasswordLink}<div><button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md btn-primary">${isLogin ? 'Sign in' : 'Sign up'}</button></div></form><p class="text-center text-sm text-gray-600">${isLogin ? "Don't have an account?" : "Already have an account?"} <button id="${isLogin ? 'show-signup' : 'show-login'}" class="font-medium text-indigo-600 hover:text-indigo-500">${isLogin ? "Sign up" : "Sign in"}</button></p></div></div></div>`; },
            roleSelectionPage: () => `<div class="page min-h-screen flex items-center justify-center bg-gray-50"><div class="max-w-2xl w-full text-center p-10 bg-white rounded-xl shadow-lg"><h2 class="text-3xl font-bold mb-8 text-gray-800">How will you be joining us?</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-6"><button data-role="Student" class="role-btn p-8 border rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition-all duration-300 transform hover:scale-105">üéì<span class="block mt-2 font-semibold">Student</span></button><button data-role="Alumni" class="role-btn p-8 border rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition-all duration-300 transform hover:scale-105">üíº<span class="block mt-2 font-semibold">Alumni</span></button><button data-role="Recruiter" class="role-btn p-8 border rounded-lg hover:bg-indigo-50 hover:border-indigo-500 transition-all duration-300 transform hover:scale-105">ü§ù<span class="block mt-2 font-semibold">Recruiter</span></button></div></div></div>`,
            studentAlumniProfileCreationPage: () => { const facultyOptions = Object.keys(deiCourses).map(f => `<option value="${f}">${f}</option>`).join(''); const isAlumni = state.userData.role === 'Alumni'; const mentorshipCheckbox = isAlumni ? `<div class="flex items-center bg-indigo-50 p-4 rounded-lg border border-indigo-200"><input id="profile-mentorship" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="profile-mentorship" class="ml-3 block text-sm font-medium text-indigo-800">I am open to mentoring students.</label></div>` : ''; return `<div class="page min-h-screen flex items-center justify-center py-12 bg-gray-50"><div class="max-w-2xl w-full p-8 bg-white rounded-xl shadow-lg space-y-6"><h2 class="text-3xl font-bold text-center text-gray-800">Complete Your Profile</h2><form id="profile-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Full Name <span class="text-red-500">*</span></label><input id="profile-name" type="text" required class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div><div><label class="block text-sm font-medium">Gender <span class="text-red-500">*</span></label><div class="mt-2 flex gap-4"><label class="flex items-center"><input type="radio" name="gender" value="Male" required class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2">Male</span></label><label class="flex items-center"><input type="radio" name="gender" value="Female" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2">Female</span></label></div></div></div><div><label class="block text-sm font-medium">Faculty <span class="text-red-500">*</span></label><select id="profile-faculty" required class="mt-1 block w-full px-3 py-2 border rounded-md input-field"><option value="">Select Faculty</option>${facultyOptions}</select></div><div><label class="block text-sm font-medium">Course <span class="text-red-500">*</span></label><select id="profile-course" required disabled class="mt-1 block w-full px-3 py-2 border rounded-md input-field bg-gray-50"><option value="">Select Course</option></select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Start Year <span class="text-red-500">*</span></label><input id="profile-start-year" type="number" placeholder="YYYY" required class="mt-1 block w-full px-3 py-2 border rounded-md input-field" min="1900" max="2025"></div><div><label class="block text-sm font-medium">End Year <span class="text-red-500">*</span></label><input id="profile-end-year" type="number" placeholder="YYYY" required class="mt-1 block w-full px-3 py-2 border rounded-md input-field" min="1900" max="2030"></div></div><div><label class="block text-sm font-medium">Headline (e.g., Software Engineer at Google)</label><input id="profile-headline" type="text" class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div><div class="space-y-4 border-t pt-4"><h3 class="text-md font-semibold text-gray-700">Work Experience</h3><div class="flex items-center"><input id="fresher-checkbox" type="checkbox" class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="fresher-checkbox" class="ml-2 block text-sm text-gray-900">I am a Fresher</label></div><div id="experience-field-container"><label class="block text-sm font-medium">Year of Joining First Job</label><input id="profile-joining-year" type="number" placeholder="YYYY" class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div></div><div><label class="block text-sm font-medium">Skills (comma-separated)</label><p class="text-xs text-gray-500 italic">Fill carefully, as this helps recruiters find you.</p><input id="profile-skills" type="text" class="mt-1 block w-full px-3 py-2 border rounded-md input-field" placeholder="e.g., React, Node.js, Python"></div><div><label class="block text-sm font-medium">LinkedIn Profile URL</label><input id="profile-linkedin" type="url" class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div><div><label class="block text-sm font-medium">GitHub Profile URL</label><input id="profile-github" type="url" class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div>${mentorshipCheckbox}<button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Save Profile</button></form></div></div>`; },
            recruiterProfileCreationPage: () => `<div class="page min-h-screen flex items-center justify-center py-12 bg-gray-50"><div class="max-w-2xl w-full p-8 bg-white rounded-xl shadow-lg space-y-6"><h2 class="text-3xl font-bold text-center text-gray-800">Complete Recruiter Profile</h2><form id="recruiter-profile-form" class="space-y-4"><div><label class="block text-sm font-medium">Full Name <span class="text-red-500">*</span></label><input id="recruiter-name" type="text" required class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div><div><label class="block text-sm font-medium">Gender <span class="text-red-500">*</span></label><div class="mt-2 flex gap-4"><label class="flex items-center"><input type="radio" name="gender" value="Male" required class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2">Male</span></label><label class="flex items-center"><input type="radio" name="gender" value="Female" class="h-4 w-4 text-indigo-600 border-gray-300 focus:ring-indigo-500"><span class="ml-2">Female</span></label></div></div><div><label class="block text-sm font-medium">Organization Name <span class="text-red-500">*</span></label><input id="recruiter-organization" type="text" required class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div><div><label class="block text-sm font-medium">Your Job Title (e.g., HR Manager) <span class="text-red-500">*</span></label><input id="recruiter-headline" type="text" required class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div><div><label class="block text-sm font-medium">Organization Website</label><input id="recruiter-website" type="url" class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div><div><label class="block text-sm font-medium">Verification Code <span class="text-red-500">*</span></label><input id="recruiter-verification-code" type="text" required class="mt-1 block w-full px-3 py-2 border rounded-md input-field"></div><button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Save Profile</button></form></div></div>`,
            dashboard: () => { const { role, displayName } = state.userData; const skeletonCard = `<div class="card p-4"><div class="flex items-center space-x-4"><div class="w-16 h-16 rounded-full skeleton-loader"></div><div class="flex-1 space-y-2"><div class="w-3/4 h-4 skeleton-loader"></div><div class="w-1/2 h-4 skeleton-loader"></div></div></div></div>`; const eventsContent = (type) => { const filteredEvents = state.events.filter(e => e.type === type); const eventCards = filteredEvents.length > 0 ? filteredEvents.map(event => `<div class="card overflow-hidden group flex flex-col"><div class="overflow-hidden"><img src="${event.image}" alt="${event.title}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"></div><div class="p-5 flex flex-col flex-grow"><h4 class="font-bold text-lg text-indigo-700">${event.title}</h4><p class="text-sm text-gray-500 mb-2">${new Date(event.date).toDateString()}</p><p class="text-gray-700 text-sm flex-grow">${event.description}</p><a href="${event.link}" target="_blank" rel="noopener noreferrer" class="mt-4 text-center btn-primary text-white px-4 py-2 rounded-md text-sm font-medium">Register Now</a></div></div>`).join('') : '<p class="text-gray-500 col-span-full">No upcoming events of this type.</p>'; return `<div class="mt-8"><h3 class="text-xl font-semibold mb-4">${type === 'college' ? 'Upcoming College Events' : 'Alumni Reunion Events'}</h3><div class="grid grid-cols-1 lg:grid-cols-2 gap-6">${eventCards}</div></div>`; }; let content = ''; let rightColumnContent = `<div class="card p-5 bg-indigo-50 border-indigo-200"><h3 class="font-bold text-indigo-800">Quote of the Day</h3><p class="mt-2 text-indigo-700 italic">"${utils.getRandomQuote()}"</p></div>`; if (state.isDataLoading) { content = `<div class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${skeletonCard.repeat(6)}</div>`; } else if (role === 'Student' || role === 'Alumni') { if(role === 'Student') { const mentors = state.users.filter(u => u.role === 'Alumni' && u.openToMentorship && u.id !== state.currentUser.uid).sort(() => 0.5 - Math.random()).slice(0, 5); const mentorHtml = mentors.map(m => `<div class="card p-4"><div class="flex items-start space-x-4"><img src="${utils.getProfileImageUrl(m)}" class="w-16 h-16 rounded-full flex-shrink-0 object-cover user-card cursor-pointer" data-userid="${m.id}"><div><h4 class="font-bold user-card cursor-pointer" data-userid="${m.id}">${m.displayName}</h4><p class="text-sm text-gray-600">${m.headline || 'Alumni'}</p>${utils.getMentorBadge(m.mentorshipsGiven)}<div class="mt-3 flex gap-2"><button class="mentor-email-btn text-xs btn-primary text-white px-3 py-1 rounded-md" data-mentorid="${m.id}">Email</button>${m.linkedin ? `<button class="mentor-linkedin-btn text-xs bg-gray-200 hover:bg-gray-300 text-gray-800 px-3 py-1 rounded-md" data-mentorid="${m.id}">LinkedIn</button>` : ''}</div></div></div></div>`).join(''); rightColumnContent += `<h3 class="text-xl font-semibold mt-6">Saarthi Mentors</h3>${mentors.length > 0 ? mentorHtml : '<p>No alumni mentors currently available.</p>'}`; } else if(role === 'Alumni') { rightColumnContent += `<div class="card p-5 mt-6"><h3 class="font-bold text-gray-800">Support Your Institute</h3><p class="text-sm text-gray-600 mt-2">Your contribution, big or small, helps shape the future of DEI. Let's give back to the institution that gave us so much.</p><div class="mt-4 flex flex-col items-center"><img src="https://firebasestorage.googleapis.com/v0/b/deioldgems.appspot.com/o/qr.jpg?alt=media&token=658dfb61-4091-4993-9c88-594364278474" alt="Fundraiser QR Code" class="w-40 h-40 rounded-lg"><p class="mt-2 text-sm font-semibold">UPI: <span class="font-mono">9999999999@upi</span></p></div></div>`; } content = `<div class="grid grid-cols-1 xl:grid-cols-3 gap-8"><div class="xl:col-span-2">${eventsContent('college')} ${role === 'Alumni' ? eventsContent('reunion') : ''}</div><div class="space-y-6">${rightColumnContent}</div></div>`; } else if (role === 'Recruiter') { const myJobs = state.jobs.filter(job => job.postedBy === state.currentUser.uid); const myJobsHtml = myJobs.length > 0 ? myJobs.map(job => { const applicants = job.applicants?.map(appId => state.users.find(u => u.id === appId)).filter(Boolean) || []; return `<div class="card p-4"><div class="flex justify-between items-start"><div><h4 class="font-bold text-indigo-700">${job.title}</h4><p class="text-sm text-gray-500">${job.location}</p></div><button data-jobid="${job.id}" data-confirm="false" class="delete-job-btn text-sm text-red-500 hover:text-red-700 font-semibold px-3 py-1 rounded-md transition-colors bg-red-50 hover:bg-red-100">Delete</button></div><div class="mt-4"><h5 class="text-sm font-semibold">Applicants (${applicants.length})</h5><div class="mt-2 text-sm max-h-24 overflow-y-auto">${applicants.length > 0 ? applicants.map(a => `<p class="applicant-name cursor-pointer hover:underline" data-userid="${a.id}">${a.displayName}</p>`).join('') : '<p class="text-gray-400">No applicants yet.</p>'}</div></div></div>` }).join('') : '<p class="text-gray-500 col-span-full">You have not posted any jobs yet.</p>'; content = `<div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Find Talent</h3><button id="post-job-btn" class="btn-primary text-white px-6 py-2 rounded-md">Post a Job</button></div><div class="bg-white p-4 rounded-lg shadow-sm flex flex-col md:grid md:grid-cols-3 gap-4"><input id="recruiter-search-name" type="text" placeholder="Search by name..." class="md:col-span-1 px-3 py-2 border rounded-md input-field"><input id="recruiter-search-skill" type="text" placeholder="Filter by skill..." class="md:col-span-1 px-3 py-2 border rounded-md input-field"><input id="recruiter-search-exp" type="number" placeholder="Min. experience (years)" class="md:col-span-1 px-3 py-2 border rounded-md input-field"><button id="recruiter-search-btn" class="md:col-span-3 btn-primary text-white px-6 py-2 rounded-md">Search</button></div><div id="recruiter-results" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"><p class="text-gray-500 col-span-full">Search for candidates above.</p></div></div><div><h3 class="text-xl font-semibold mb-4">Your Job Postings</h3><div class="space-y-4">${myJobsHtml}</div></div></div></div>`; } return `<div class="page max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold text-gray-900">Welcome, ${displayName}!</h1><p class="text-gray-600">Your ${role} Dashboard</p>${content}</div>`; },
            profilePage: () => { const user = state.userData; if (!user) return render.dashboard(); let mentorshipManagementHtml = ''; if (user.role === 'Student' && user.pendingMentorships?.length > 0) { const pendingMentors = user.pendingMentorships.map(id => state.users.find(u => u.id === id)).filter(Boolean); mentorshipManagementHtml = `<div id="mentorship-management-section" class="mt-8 pt-6 border-t"><h3 class="text-lg font-medium text-gray-800">My Mentorships (Pending)</h3><p class="mt-1 text-sm text-gray-500">Please confirm once you've connected with your mentor.</p><div class="space-y-3 mt-4">${pendingMentors.map(p => `<div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg"><div><p class="font-semibold">${p.displayName}</p><p class="text-xs text-gray-500">${p.headline}</p></div><div class="flex gap-2"><button class="resolve-mentorship-btn text-xs bg-green-500 text-white px-3 py-1 rounded-md" data-mentorid="${p.id}" data-action="confirm">Got Mentorship</button><button class="resolve-mentorship-btn text-xs bg-red-500 text-white px-3 py-1 rounded-md" data-mentorid="${p.id}" data-action="remove">Not Helpful</button></div></div>`).join('')}</div></div>`; } const deleteProfileButton = `<div class="mt-8 pt-6 border-t border-gray-200"><h3 class="text-lg font-medium text-red-600">Danger Zone</h3><p class="mt-1 text-sm text-gray-500">Deleting your profile is permanent and cannot be undone.</p><button id="delete-profile-btn" data-confirm="false" class="mt-4 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700">Delete My Profile</button></div>`; if (user.role === 'Recruiter' || user.role === 'Admin') { return `<div class="page max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8"><div class="card p-8"><form id="profile-update-form"><div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-8"><img src="${utils.getProfileImageUrl(user)}" alt="Profile Picture" class="w-24 h-24 rounded-full flex-shrink-0 object-cover"><div class="flex-grow text-center sm:text-left"><h2 class="text-2xl font-bold">${user.displayName}</h2><p class="text-gray-500">${user.headline || user.role}</p></div><button type="submit" class="btn-primary text-white px-6 py-2 rounded-md">Save Changes</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">Full Name</label><input id="profile-name-update" type="text" value="${user.displayName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Job Title</label><input id="profile-headline-update" type="text" value="${user.headline || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div class="md:col-span-2"><label class="block text-sm font-medium">Organization</label><input id="profile-organization-update" type="text" value="${user.organizationName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div class="md:col-span-2"><label class="block text-sm font-medium">Website</label><input id="profile-website-update" type="url" value="${user.website || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div></div></form>${deleteProfileButton}</div></div>`; } const facultyOptions = Object.keys(deiCourses).map(f => `<option value="${f}" ${user.faculty === f ? 'selected' : ''}>${f}</option>`).join(''); const mentorshipCheckbox = user.role === 'Alumni' ? `<div class="md:col-span-2 flex items-center bg-indigo-50 p-3 rounded-md border border-indigo-200"><input id="profile-mentorship-update" type="checkbox" ${user.openToMentorship ? 'checked' : ''} class="h-4 w-4 text-indigo-600 border-gray-300 rounded focus:ring-indigo-500"><label for="profile-mentorship-update" class="ml-3 block text-sm font-medium text-indigo-800">I am open to mentoring students.</label></div>` : ''; return `<div class="page max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8"><div class="card p-8"><form id="profile-update-form"><div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-8"><img src="${utils.getProfileImageUrl(user)}" alt="Profile Picture" class="w-24 h-24 rounded-full flex-shrink-0 object-cover"><div class="flex-grow text-center sm:text-left"><h2 class="text-2xl font-bold">${user.displayName}</h2><p class="text-gray-500">${user.role}</p></div><button type="submit" class="btn-primary text-white px-6 py-2 rounded-md">Save Changes</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">Full Name</label><input id="profile-name-update" type="text" value="${user.displayName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Headline</label><input id="profile-headline-update" type="text" value="${user.headline || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Faculty</label><select id="profile-faculty-update" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field">${facultyOptions}</select></div><div><label class="block text-sm font-medium">Course</label><select id="profile-course-update" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:col-span-2"><div><label class="block text-sm font-medium">Start Year</label><input id="profile-start-year-update" type="number" placeholder="YYYY" value="${user.startYear || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" min="1900" max="2025"></div><div><label class="block text-sm font-medium">End Year</label><input id="profile-end-year-update" type="number" placeholder="YYYY" value="${user.endYear || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" min="1900" max="2030"></div></div><div class="md:col-span-2"><label class="block text-sm font-medium">Year of Joining First Job</label><input id="profile-joining-year-update" type="number" value="${user.yearOfJoining || ''}" placeholder="YYYY" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div class="md:col-span-2"><label class="block text-sm font-medium">Skills (comma-separated)</label><p class="text-xs text-gray-500 italic">Fill carefully, as this helps recruiters find you.</p><input id="profile-skills-update" type="text" value="${(user.skills || []).join(', ')}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">LinkedIn URL</label><input id="profile-linkedin-update" type="url" value="${user.linkedin || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">GitHub URL</label><input id="profile-github-update" type="url" value="${user.github || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div>${mentorshipCheckbox}</div></form>${mentorshipManagementHtml}${deleteProfileButton}</div></div>`; },
            chatPage: () => `<div class="page max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 h-[calc(100vh-80px)] flex flex-col"><h1 class="text-3xl font-bold mb-4">Global Chat Room</h1><div id="chat-box" class="flex-grow bg-white border rounded-lg p-4 overflow-y-auto mb-4 flex flex-col space-y-2">${state.chatMessages.map(msg => { const isMe = msg.uid === state.currentUser.uid; const user = state.users.find(u => u.id === msg.uid); return `<div class="flex items-end gap-2 ${isMe ? 'flex-row-reverse' : ''}"><img src="${utils.getProfileImageUrl(user)}" class="w-8 h-8 rounded-full"><div class="max-w-xs lg:max-w-md p-3 rounded-lg ${isMe ? 'bg-indigo-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}"><p class="font-bold text-sm flex items-center">${isMe ? 'You' : msg.displayName} ${user ? utils.getRoleBadge(user.role) : ''}</p><p class="mt-1 break-words">${msg.text}</p><p class="text-xs text-right opacity-70 mt-1">${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}</p></div></div>`; }).join('')}</div><form id="chat-form" class="flex gap-4"><input id="chat-input" type="text" placeholder="Type a message..." required class="flex-grow px-4 py-2 border rounded-lg input-field"><button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Send</button></form></div>`,
            jobBoardPage: () => { const jobList = state.jobs.map(job => { const hasApplied = job.applicants && job.applicants.includes(state.currentUser.uid); const recruiter = state.users.find(u => u.id === job.postedBy); return `<div class="card p-5 flex flex-col"><div class="flex justify-between items-start"><div><h3 class="text-lg font-bold text-indigo-700">${job.title}</h3><p class="text-sm font-medium text-gray-600">${recruiter?.organizationName || job.company}</p><p class="text-sm text-gray-500">${job.location}</p></div><img src="${utils.getProfileImageUrl(recruiter)}" class="w-12 h-12 rounded-full object-cover"></div><p class="text-sm text-gray-700 mt-4 whitespace-pre-wrap flex-grow">${job.description}</p><div class="mt-4"><button data-jobid="${job.id}" class="w-full text-center btn-primary text-white px-4 py-2 rounded-md text-sm font-medium apply-btn" ${hasApplied ? 'disabled' : ''}>${hasApplied ? 'Applied' : 'Apply Now'}</button></div></div>` }).join(''); return `<div class="page max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold text-gray-900">Job Board</h1><p class="text-gray-600">Opportunities posted by our network of recruiters.</p><div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${state.jobs.length > 0 ? jobList : '<p class="col-span-full text-center text-gray-500">No job openings at the moment. Check back later!</p>'}</div></div>`; },
            adminPage: () => { const managementCard = (title, content, buttonId, buttonText) => `<div class="card p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">${title}</h2>${buttonId ? `<button id="${buttonId}" class="btn-primary text-white px-4 py-2 text-sm rounded-md">${buttonText}</button>` : ''}</div><div class="overflow-x-auto">${content}</div></div>`; const usersTable = `<table class="w-full text-sm text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-2 font-semibold">Name</th><th class="p-2 font-semibold">Email</th><th class="p-2 font-semibold">Role</th><th class="p-2 font-semibold">Actions</th></tr></thead><tbody>${state.users.map(user => `<tr class="border-b"><td class="p-2">${user.displayName}</td><td class="p-2">${user.email}</td><td class="p-2">${user.role}</td><td class="p-2"><button class="admin-edit-user-btn text-blue-500 hover:underline" data-userid="${user.id}">Edit</button><button class="admin-delete-user-btn text-red-500 hover:underline ml-4" data-userid="${user.id}">Delete</button></td></tr>`).join('')}</tbody></table>`; const messagesList = `<ul class="divide-y">${state.chatMessages.map(msg => `<li class="py-2 flex justify-between items-center"><span><b>${msg.displayName}:</b> ${msg.text}</span><button class="admin-delete-msg-btn text-red-500 hover:underline" data-msgid="${msg.id}">Delete</button></li>`).join('') || '<li>No messages.</li>'}</ul>`; const jobsTable = `<table class="w-full text-sm text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-2 font-semibold">Title</th><th class="p-2 font-semibold">Company</th><th class="p-2 font-semibold">Actions</th></tr></thead><tbody>${state.jobs.map(job => `<tr class="border-b"><td class="p-2">${job.title}</td><td class="p-2">${job.company}</td><td class="p-2"><button class="admin-edit-job-btn text-blue-500 hover:underline" data-jobid="${job.id}">Edit</button><button class="admin-delete-job-btn text-red-500 hover:underline ml-4" data-jobid="${job.id}">Delete</button></td></tr>`).join('')}</tbody></table>`; const eventsTable = `<table class="w-full text-sm text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-2 font-semibold">Title</th><th class="p-2 font-semibold">Date</th><th class="p-2 font-semibold">Type</th><th class="p-2 font-semibold">Actions</th></tr></thead><tbody>${state.events.map(event => `<tr class="border-b"><td class="p-2">${event.title}</td><td class="p-2">${event.date}</td><td class="p-2">${event.type}</td><td class="p-2"><button class="admin-edit-event-btn text-blue-500 hover:underline" data-eventid="${event.id}">Edit</button><button class="admin-delete-event-btn text-red-500 hover:underline ml-4" data-eventid="${event.id}">Delete</button></td></tr>`).join('')}</tbody></table>`; return `<div class="page max-w-7xl mx-auto py-8 px-4"><h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1><div class="space-y-8">${managementCard('User Management', usersTable, null, null)}${managementCard('Job Postings', jobsTable, 'admin-add-job-btn', 'Add Job')}${managementCard('Event Management', eventsTable, 'admin-add-event-btn', 'Add Event')}<div class="card p-6"><h2 class="text-xl font-semibold mb-4">Recent Messages</h2>${messagesList}</div></div></div>`; },
            adminModal: (title, formHtml, formId) => { dom.modalContainer.innerHTML = `<div class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${title}</h2><button id="close-modal-btn" class="text-gray-500 text-3xl">&times;</button></div><form id="${formId}" class="space-y-4">${formHtml}<button type="submit" class="btn-primary text-white w-full py-2 rounded-md mt-4">Save</button></form></div></div>`; },
            userProfileModal: (user) => { if (!user) { dom.modalContainer.innerHTML = ''; return; } let detailsHtml = ''; const iconLink = (href, svg, text) => href ? `<a href="${href}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors">${svg}<span>${text}</span></a>` : ''; const mailSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope-fill" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.803V4.697l-5.803 3.558z"/></svg>`; const linkedinSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/></svg>`; const githubSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>`; if (user.role === 'Recruiter') { detailsHtml = `<h3 class="font-semibold border-b pb-1">Organization</h3><p class="text-gray-700">${user.organizationName || 'Not specified.'}</p>`; } else { const experienceYears = user.yearOfJoining ? new Date().getFullYear() - user.yearOfJoining : 0; const experienceText = user.yearOfJoining ? `${experienceYears} year(s)` : 'Fresher'; const academicInfo = user.faculty ? `<h3 class="font-semibold border-b pb-1">Academics</h3><p class="text-gray-700">${user.course || ''}<br><span class="text-sm text-gray-500">${user.faculty} (${user.startYear} - ${user.endYear})</span></p>` : ''; let mentorshipSection = ''; if(user.role === 'Student' && user.confirmedMentors?.length) { const mentorNames = user.confirmedMentors.map(id => state.users.find(u => u.id === id)?.displayName).filter(Boolean).join(', '); mentorshipSection = `<h3 class="font-semibold border-b pb-1">Spotlight Medal</h3><p class="text-gray-700">Mentored by: <span class="font-semibold text-indigo-700">${mentorNames}</span></p>`} detailsHtml = `${academicInfo}<h3 class="font-semibold border-b pb-1">Experience</h3><p class="text-gray-700">${experienceText}</p><h3 class="font-semibold border-b pb-1">Skills</h3><p class="text-gray-700">${(user.skills || []).join(', ') || 'Not specified.'}</p>${mentorshipSection}`; } const mentorshipGiven = (user.role === 'Alumni' && user.openToMentorship) ? `<p class="text-sm text-gray-500">Mentored ${user.mentorshipsGiven || 0} students</p>` : `<p class="text-gray-600">${user.headline || user.role}</p>`; dom.modalContainer.innerHTML = `<div class="modal-backdrop" id="profile-modal-backdrop"><div class="modal-content relative transition-all duration-300"><button id="close-modal-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button><div class="flex flex-col sm:flex-row items-center gap-6 mb-6"><img src="${utils.getProfileImageUrl(user)}" class="w-24 h-24 rounded-full flex-shrink-0 object-cover shadow-lg"><div class="text-center sm:text-left"><h2 class="text-2xl font-bold">${user.displayName} ${user.role === 'Alumni' ? utils.getMentorBadge(user.mentorshipsGiven) : ''}</h2>${mentorshipGiven}<div class="flex justify-center sm:justify-start flex-wrap gap-3 mt-4">${iconLink(`mailto:${user.email}`, mailSvg, 'Email')}${user.linkedin ? iconLink(user.linkedin, linkedinSvg, 'LinkedIn') : ''}${iconLink(user.github, githubSvg, 'GitHub')}</div></div></div><div class="space-y-4 text-sm">${detailsHtml}</div></div></div>`; },
            postJobModal: () => { dom.modalContainer.innerHTML = `<div class="modal-backdrop" id="post-job-modal-backdrop"><div class="modal-content relative"><button id="close-modal-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button><h2 class="text-2xl font-bold mb-4">Post a New Job</h2><form id="post-job-form" class="space-y-4"><div><label class="block text-sm font-medium">Job Title <span class="text-red-500">*</span></label><input id="job-title" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Location <span class="text-red-500">*</span></label><input id="job-location" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" placeholder="e.g., Agra, India or Remote"></div><div><label class="block text-sm font-medium">Job Description <span class="text-red-500">*</span></label><textarea id="job-description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" rows="5"></textarea></div><div><label class="block text-sm font-medium">Application Link or Email <span class="text-red-500">*</span></label><input id="job-link" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Post Job</button></form></div></div>`; },
            forgotPasswordModal: () => { dom.modalContainer.innerHTML = `<div class="modal-backdrop" id="forgot-password-modal-backdrop"><div class="modal-content relative"><button id="close-modal-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button><h2 class="text-2xl font-bold mb-4">Reset Password</h2><p class="text-sm text-gray-600 mb-4">Enter your email address and we will send you a link to reset your password.</p><form id="forgot-password-form" class="space-y-4"><div><label class="block text-sm font-medium">Email Address <span class="text-red-500">*</span></label><input id="forgot-email" type="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Send Reset Link</button></form></div></div>`; },
            reauthModal: () => { dom.modalContainer.innerHTML = `<div class="modal-backdrop" id="reauth-modal-backdrop"><div class="modal-content relative"><button id="close-modal-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button><h2 class="text-2xl font-bold mb-4">Confirm Your Password</h2><p class="text-sm text-gray-600 mb-4">For your security, please re-enter your password to delete your profile.</p><form id="reauth-form" class="space-y-4"><div><label class="block text-sm font-medium">Password <span class="text-red-500">*</span></label><input id="reauth-password" type="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Confirm and Delete</button></form></div></div>`; },
            alumniDataPage: () => { const currentYear = new Date().getFullYear(); const years = Array.from({ length: 10 }, (_, i) => currentYear - i); return `<div class="page max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold text-gray-900">Alumni Data</h1><p class="text-gray-600 mb-6">Select a year to view and download alumni data.</p><div class="flex flex-col sm:flex-row gap-4 mb-6"><select id="year-select" class="input-field p-2 border rounded-md"><option value="">Select Year</option>${years.map(y => `<option value="${y}">${y}</option>`).join('')}</select><input id="alumni-search" type="text" placeholder="Search in table..." class="input-field p-2 border rounded-md flex-grow"><button id="download-alumni-xls" class="btn-primary text-white px-4 py-2 rounded-md">Download XLSX</button></div><div id="alumni-data-container" class="bg-white p-4 rounded-lg shadow overflow-x-auto"><p class="text-gray-500">Please select a year to display data.</p></div></div>`; },
            alumniDataTable: (data) => { const container = document.getElementById('alumni-data-container'); if (!container) return; if (data.length === 0) { container.innerHTML = '<p class="text-gray-500">No data found for this year or search query.</p>'; return; } const headers = Object.keys(data[0]); container.innerHTML = `<table id="alumni-data-table" class="w-full text-sm"><thead><tr class="bg-gray-50 border-b">${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${data.map(row => `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`).join('')}</tbody></table>`; },
            MargdarshakAiPage: () => { let historyHtml = state.MargdarshakHistory.map(msg => `<div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}"><div class="max-w-lg p-3 rounded-lg ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model'}">${msg.parts[0].text}</div></div>`).join(''); if (state.isAiResponding) { historyHtml += `<div class="flex justify-start"><div class="max-w-lg p-3 rounded-lg chat-bubble-model"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`; } return `<div class="page max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col h-[calc(100vh-80px)] saarthi-bg rounded-lg shadow-inner"><div class="flex-shrink-0 text-white bg-indigo-800/50 p-4 rounded-t-lg backdrop-blur-sm"><h1 class="text-3xl font-bold">Margdarshak AI Mentor</h1><p>Your personal AI career counselor for technical and interview guidance.</p></div><div id="Margdarshak-chat-history" class="flex-grow bg-white/80 backdrop-blur-sm p-4 overflow-y-auto mb-4 space-y-4">${historyHtml}</div><form id="Margdarshak-form" class="flex-shrink-0 flex gap-4 p-4 bg-white/80 backdrop-blur-sm rounded-b-lg"><input id="Margdarshak-input" type="text" placeholder="Ask about a technical concept..." required class="flex-grow px-4 py-2 border rounded-lg input-field"><button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Send</button></form></div>`; },
            app: () => { if (state.currentPage === 'loading') { dom.appContainer.innerHTML = ''; return; } else { dom.appLoader.classList.add('fade-out'); setTimeout(() => dom.appLoader.style.display = 'none', 500); } let pageContent = ''; switch (state.currentPage) { case 'login': pageContent = render.authPage(true); break; case 'signup': pageContent = render.authPage(false); break; case 'selectRole': pageContent = render.roleSelectionPage(); break; case 'createProfile': pageContent = render.studentAlumniProfileCreationPage(); break; case 'createRecruiterProfile': pageContent = render.recruiterProfileCreationPage(); break; case 'dashboard': pageContent = render.navbar() + render.dashboard(); break; case 'profile': pageContent = render.navbar() + render.profilePage(); break; case 'chat': pageContent = render.navbar() + render.chatPage(); break; case 'jobs': pageContent = render.navbar() + render.jobBoardPage(); break; case 'admin': pageContent = render.navbar() + render.adminPage(); break; case 'alumniData': pageContent = render.navbar() + render.alumniDataPage(); break; case 'MargdarshakAi': pageContent = render.navbar() + render.MargdarshakAiPage(); break; default: pageContent = render.authPage(true); } dom.appContainer.innerHTML = pageContent; if (state.viewingProfile) render.userProfileModal(state.viewingProfile); else dom.modalContainer.innerHTML = ''; addEventListeners(); if (state.currentPage === 'chat') {const chatBox = document.getElementById('chat-box'); if(chatBox) chatBox.scrollTop = chatBox.scrollHeight;} if (state.currentPage === 'MargdarshakAi') {const aiChatHistory = document.getElementById('Margdarshak-chat-history'); if(aiChatHistory) aiChatHistory.scrollTop = aiChatHistory.scrollHeight;} }
        };

        const handlers = {
            authAction: async (e, isLogin) => { e.preventDefault(); const email = document.getElementById(`${isLogin ? 'login' : 'signup'}-email`).value; const password = document.getElementById(`${isLogin ? 'login' : 'signup'}-password`).value; try { if (isLogin) await signInWithEmailAndPassword(auth, email, password); else await createUserWithEmailAndPassword(auth, email, password); utils.showToast(`Logged in successfully!`); } catch (error) { utils.showToast(error.message, 'error'); } },
            logout: async () => { await signOut(auth); window.location.reload(); },
            roleSelection: async (e) => { const role = e.currentTarget.dataset.role; await setDoc(doc(db, `artifacts/${appId}/users/${state.currentUser.uid}`), { role }, { merge: true }); state.userData.role = role; state.currentPage = role === 'Recruiter' ? 'createRecruiterProfile' : 'createProfile'; render.app(); },
            profileCreate: async (e) => { e.preventDefault(); const startYear = parseInt(document.getElementById('profile-start-year').value); const endYear = parseInt(document.getElementById('profile-end-year').value); const isFresher = document.getElementById('fresher-checkbox').checked; const joiningYear = isFresher ? null : document.getElementById('profile-joining-year').value; if (startYear < 1900 || startYear > new Date().getFullYear() || endYear < 1900 || endYear > (new Date().getFullYear() + 7) || startYear >= endYear) { utils.showToast("Please enter valid start and end years.", "error"); return; } const isAlumni = state.userData.role === 'Alumni'; const userData = { displayName: document.getElementById('profile-name').value, gender: document.querySelector('input[name="gender"]:checked').value, faculty: document.getElementById('profile-faculty').value, course: document.getElementById('profile-course').value, startYear: startYear, endYear: endYear, headline: document.getElementById('profile-headline').value, yearOfJoining: joiningYear, skills: document.getElementById('profile-skills').value.split(',').map(s => s.trim()).filter(Boolean), linkedin: document.getElementById('profile-linkedin').value, github: document.getElementById('profile-github').value, openToMentorship: isAlumni ? document.getElementById('profile-mentorship').checked : false, mentorshipsGiven: 0, pendingMentorships: [], confirmedMentors: [], email: state.currentUser.email }; await setDoc(doc(db, `artifacts/${appId}/users/${state.currentUser.uid}`), userData, { merge: true }); state.userData = { ...state.userData, ...userData }; state.currentPage = 'dashboard'; render.app(); utils.showToast('Profile created!'); },
            recruiterProfileCreate: async (e) => { e.preventDefault(); const verificationCode = document.getElementById('recruiter-verification-code').value; if (!recruiterVerificationCodes.includes(verificationCode)) { utils.showToast("Verification code incorrect. Visit college faculty to get correct code.", "error"); return; } const userData = { displayName: document.getElementById('recruiter-name').value, gender: document.querySelector('input[name="gender"]:checked').value, organizationName: document.getElementById('recruiter-organization').value, headline: document.getElementById('recruiter-headline').value, website: document.getElementById('recruiter-website').value, email: state.currentUser.email, verified: true }; await setDoc(doc(db, `artifacts/${appId}/users/${state.currentUser.uid}`), userData, { merge: true }); state.userData = { ...state.userData, ...userData }; state.currentPage = 'dashboard'; render.app(); utils.showToast('Profile created!'); },
            profileUpdate: async (e) => { e.preventDefault(); let updatedData; if (state.userData.role === 'Recruiter' || state.userData.role === 'Admin') { updatedData = { displayName: document.getElementById('profile-name-update').value, headline: document.getElementById('profile-headline-update').value, organizationName: document.getElementById('profile-organization-update').value, website: document.getElementById('profile-website-update').value }; } else { const startYear = parseInt(document.getElementById('profile-start-year-update').value); const endYear = parseInt(document.getElementById('profile-end-year-update').value); if (startYear < 1900 || startYear > new Date().getFullYear() || endYear < 1900 || endYear > (new Date().getFullYear() + 7) || startYear >= endYear) { utils.showToast("Please enter valid start and end years.", "error"); return; } const isAlumni = state.userData.role === 'Alumni'; updatedData = { displayName: document.getElementById('profile-name-update').value, headline: document.getElementById('profile-headline-update').value, faculty: document.getElementById('profile-faculty-update').value, course: document.getElementById('profile-course-update').value, startYear: startYear, endYear: endYear, yearOfJoining: document.getElementById('profile-joining-year-update').value, skills: document.getElementById('profile-skills-update').value.split(',').map(s => s.trim()).filter(Boolean), linkedin: document.getElementById('profile-linkedin-update').value, github: document.getElementById('profile-github-update').value, }; if(isAlumni) { updatedData.openToMentorship = document.getElementById('profile-mentorship-update').checked; } } await setDoc(doc(db, `artifacts/${appId}/users/${state.currentUser.uid}`), updatedData, { merge: true }); state.userData = { ...state.userData, ...updatedData }; utils.showToast('Profile updated!'); state.currentPage = 'profile'; render.app(); },
            viewProfile: (userId) => { const userToView = state.users.find(u => u.id === userId); if (userToView) { state.viewingProfile = userToView; render.app(); } },
            search: (query, resultsContainer) => { if (!query) { resultsContainer.classList.add('hidden'); return; } const filteredUsers = state.users.filter(user => user.displayName && user.displayName.toLowerCase().includes(query.toLowerCase()) && user.id !== state.currentUser.uid && user.role !== 'Recruiter'); if (filteredUsers.length > 0) { resultsContainer.innerHTML = filteredUsers.map(user => `<div class="p-3 hover:bg-gray-100 cursor-pointer border-b flex items-center gap-3" data-userid="${user.id}"><img src="${utils.getProfileImageUrl(user)}" class="w-10 h-10 rounded-full object-cover"><div><p class="font-semibold">${user.displayName}</p><p class="text-sm text-gray-500">${user.headline || user.role}</p></div></div>`).join(''); resultsContainer.classList.remove('hidden'); resultsContainer.querySelectorAll('div[data-userid]').forEach(el => el.addEventListener('mousedown', () => handlers.viewProfile(el.dataset.userid))); } else { resultsContainer.classList.add('hidden'); } },
            recruiterSearch: () => { const nameQuery = document.getElementById('recruiter-search-name').value.toLowerCase(); const skillQuery = document.getElementById('recruiter-search-skill').value.toLowerCase(); const minExp = parseInt(document.getElementById('recruiter-search-exp').value) || 0; const resultsContainer = document.getElementById('recruiter-results'); const currentYear = new Date().getFullYear(); const filtered = state.users.filter(u => { if (u.role === 'Recruiter') return false; const nameMatch = !nameQuery || (u.displayName && u.displayName.toLowerCase().includes(nameQuery)); const skillMatch = !skillQuery || (u.skills && u.skills.some(skill => skill.toLowerCase().includes(skillQuery))); const userExp = u.yearOfJoining ? currentYear - parseInt(u.yearOfJoining) : 0; const expMatch = userExp >= minExp; return nameMatch && skillMatch && expMatch; }); if (filtered.length > 0) { resultsContainer.innerHTML = filtered.map(user => `<div class="card p-4 user-card cursor-pointer" data-userid="${user.id}"><div class="flex items-center space-x-4"><img src="${utils.getProfileImageUrl(user)}" class="w-16 h-16 rounded-full flex-shrink-0 object-cover"><div><h4 class="font-bold">${user.displayName}</h4><p class="text-sm text-gray-600">${user.headline || user.role}</p><div class="mt-2 flex flex-wrap gap-1">${(user.skills || []).slice(0, 3).map(skill => `<span class="bg-indigo-100 text-indigo-700 text-xs font-medium px-2 py-1 rounded-full">${skill}</span>`).join('')}</div></div></div></div>`).join(''); resultsContainer.querySelectorAll('.user-card').forEach(card => card.addEventListener('click', (e) => handlers.viewProfile(e.currentTarget.dataset.userid))); } else { resultsContainer.innerHTML = `<p class="text-gray-600 md:col-span-3 text-center">No candidates found matching your criteria.</p>`; } },
            sendMessage: async (e) => { e.preventDefault(); const input = document.getElementById('chat-input'); const text = input.value.trim(); const lowerCaseText = text.toLowerCase(); if (inappropriateWords.some(word => lowerCaseText.includes(word))) { utils.showToast("Inappropriate language detected. Message not sent.", "error"); return; } if (text) { await addDoc(collection(db, `artifacts/${appId}/chats`), { text, uid: state.currentUser.uid, displayName: state.userData.displayName, timestamp: serverTimestamp() }); input.value = ''; } },
            postJob: async (e) => { e.preventDefault(); try { if (!state.userData.organizationName) { utils.showToast("Please add an organization name to your profile before posting a job.", "error"); dom.modalContainer.innerHTML = ''; state.currentPage = 'profile'; render.app(); return; } const jobData = { title: document.getElementById('job-title').value, location: document.getElementById('job-location').value, description: document.getElementById('job-description').value, link: document.getElementById('job-link').value, postedBy: state.currentUser.uid, company: state.userData.organizationName, timestamp: serverTimestamp(), applicants: [] }; await addDoc(collection(db, `artifacts/${appId}/jobs`), jobData); utils.showToast("Job posted successfully!"); dom.modalContainer.innerHTML = ''; } catch (error) { console.error("Error posting job:", error); utils.showToast("An error occurred while posting the job.", "error"); } },
            applyForJob: async (jobId) => { const jobRef = doc(db, `artifacts/${appId}/jobs`, jobId); await updateDoc(jobRef, { applicants: arrayUnion(state.currentUser.uid) }); utils.showToast("Applied Successfully!"); },
            deleteJob: async (e) => { const button = e.target; const jobId = button.dataset.jobid; if (button.dataset.confirm === 'true') { try { await deleteDoc(doc(db, `artifacts/${appId}/jobs`, jobId)); utils.showToast("Job posting deleted."); } catch (error) { utils.showToast("Error deleting job.", "error"); } } else { button.textContent = 'Are you sure?'; button.classList.add('bg-red-700'); button.dataset.confirm = 'true'; setTimeout(() => { button.textContent = 'Delete'; button.classList.remove('bg-red-700'); button.dataset.confirm = 'false'; }, 3000); } },
            deleteProfile: async (e) => { const button = e.target; if (button.dataset.confirm === 'true') { try { const user = auth.currentUser; await deleteDoc(doc(db, `artifacts/${appId}/users`, user.uid)); await deleteUser(user); utils.showToast("Profile deleted successfully."); } catch (error) { if (error.code === 'auth/requires-recent-login') { render.reauthModal(); const close = () => { dom.modalContainer.innerHTML = ''; }; document.getElementById('close-modal-btn')?.addEventListener('click', close); document.getElementById('reauth-modal-backdrop')?.addEventListener('click', (evt) => { if (evt.target.id === 'reauth-modal-backdrop') close(); }); document.getElementById('reauth-form')?.addEventListener('submit', async (evt) => { evt.preventDefault(); try { const currentUser = auth.currentUser; const password = document.getElementById('reauth-password').value; const credential = EmailAuthProvider.credential(currentUser.email, password); await reauthenticateWithCredential(currentUser, credential); await deleteDoc(doc(db, `artifacts/${appId}/users`, currentUser.uid)); await deleteUser(currentUser); utils.showToast("Profile deleted successfully."); close(); } catch (reauthErr) { utils.showToast(reauthErr.message || "Could not delete profile.", "error"); } }); } else { utils.showToast("Error deleting profile. Please log out and log in again before retrying.", "error"); } } } else { button.textContent = 'Confirm Deletion'; button.classList.add('bg-red-800'); button.dataset.confirm = 'true'; setTimeout(() => { button.textContent = 'Delete My Profile'; button.classList.remove('bg-red-800'); button.dataset.confirm = 'false'; }, 4000); } },
            forgotPassword: async (e) => { e.preventDefault(); const email = document.getElementById('forgot-email').value; if (!email) { utils.showToast("Please enter an email address.", "error"); return; } try { await sendPasswordResetEmail(auth, email); utils.showToast("Password reset email sent! Please check your inbox (and spam folder)."); dom.modalContainer.innerHTML = ''; } catch (error) { if (error.code === 'auth/user-not-found') { utils.showToast("No account found with this email address.", "error"); } else { utils.showToast("An error occurred. Please try again later.", "error"); } } },
            requestMentorship: async (e) => { const mentorId = e.target.dataset.mentorid; const type = e.target.classList.contains('mentor-email-btn') ? 'email' : 'linkedin'; const mentor = state.users.find(u => u.id === mentorId); const student = state.userData; if (!mentor || !student) { utils.showToast('Could not find user data.', 'error'); return; } if(student.pendingMentorships?.includes(mentorId) || student.confirmedMentors?.includes(mentorId)) { utils.showToast('You have already requested mentorship from this person.', 'error'); return; } try { const studentRef = doc(db, `artifacts/${appId}/users`, student.id); await updateDoc(studentRef, { pendingMentorships: arrayUnion(mentor.id) }); if (type === 'email') { const subject = encodeURIComponent(`Mentorship Enquiry from a DEI Junior`); const body = encodeURIComponent(`Dear ${mentor.displayName},\n\nI hope this email finds you well.\n\nMy name is ${student.displayName}, and I am currently pursuing ${student.course || 'my studies'} at DEI. My key skills include ${(student.skills || []).join(', ') || 'a desire to learn'}.\n\nI came across your profile on our alumni network, AlmaLink, and was very impressed by your experience, particularly with ${mentor.headline || 'your career path'}.\n\nAs I navigate my own career path, I am seeking guidance from experienced professionals like yourself. Would you be open to a brief conversation to share some insights? Any advice you could offer would be immensely valuable.\n\nThank you for considering my request. I look forward to hearing from you.\n\nWith regards,\n${student.displayName}`); window.location.href = `mailto:${mentor.email}?subject=${subject}&body=${body}`; } else { const message = `Hi ${mentor.displayName}, I'm ${student.displayName}, a student from DEI pursuing ${student.course}. I found your impressive profile on AlmaLink and would be grateful for the chance to connect and learn from your experience.`; await navigator.clipboard.writeText(message); utils.showToast('LinkedIn message copied to clipboard!'); window.open(mentor.linkedin, '_blank'); } utils.showToast('Mentorship request sent!'); } catch (error) { console.error("Mentorship request failed:", error); utils.showToast('An error occurred.', 'error'); } },
            resolveMentorship: async (e) => { const { mentorid, action } = e.target.dataset; const studentRef = doc(db, `artifacts/${appId}/users`, state.currentUser.uid); await updateDoc(studentRef, { pendingMentorships: arrayRemove(mentorid) }); if (action === 'confirm') { await updateDoc(studentRef, { confirmedMentors: arrayUnion(mentorid) }); const mentorRef = doc(db, `artifacts/${appId}/users`, mentorid); await updateDoc(mentorRef, { mentorshipsGiven: increment(1) }); utils.showToast('Mentorship confirmed! Thank you.'); } else { utils.showToast('Request removed.'); } },
            adminSave: async (e, collectionName, docId) => { e.preventDefault(); const form = e.target; const data = Object.fromEntries(new FormData(form)); const fullCollectionPath = `artifacts/${appId}/${collectionName}`; try { if (docId) { await updateDoc(doc(db, fullCollectionPath, docId), data); } else if (collectionName === 'jobs' || collectionName === 'events') { await addDoc(collection(db, fullCollectionPath), { ...data, timestamp: serverTimestamp() }); } else if (collectionName === 'users') { await setDoc(doc(db, fullCollectionPath, docId), data, { merge: true }); } utils.showToast(`${collectionName.slice(0, -1)} saved.`); dom.modalContainer.innerHTML = ''; } catch (error) { console.error("Firestore Save Error:", { collectionName, docId, currentUser: state.currentUser?.email, isAdmin: state.isAdmin, error }); utils.showToast(`Error saving: ${error.message}`, 'error'); } },
            adminDelete: async (e, collectionName, docId) => { const button = e.target; if (button.dataset.confirm === 'true') { const fullPath = `artifacts/${appId}/${collectionName}`; try { await deleteDoc(doc(db, fullPath, docId)); utils.showToast(`${collectionName.slice(0, -1)} deleted.`); } catch (err) { console.error(`Error deleting from ${collectionName}:`, err); utils.showToast('Delete failed.', 'error'); } } else { const originalText = button.textContent; button.textContent = 'Confirm Delete?'; button.dataset.originalText = originalText; button.classList.add('bg-red-600', 'text-white'); button.dataset.confirm = 'true'; setTimeout(() => { if (button.dataset.confirm === 'true') { button.textContent = originalText; button.classList.remove('bg-red-600', 'text-white'); button.dataset.confirm = 'false'; } }, 3000); } },
            openAdminModal: (collectionName, docId = null) => { const stateKey = collectionName === 'chats' ? 'chatMessages' : collectionName; const item = docId ? state[stateKey].find(i => i.id === docId) : {}; let fields = ''; const fieldMap = { users: { displayName: { type: 'text', required: true }, email: { type: 'email', required: true }, role: { type: 'text', required: true } }, jobs: { title: { type: 'text', required: true }, company: { type: 'text', required: true }, location: { type: 'text', required: true }, description: { type: 'textarea', required: true } }, events: { title: { type: 'text', required: true }, date: { type: 'date', required: true }, type: { type: 'select', options: ['college', 'reunion'], required: true }, description: { type: 'textarea', required: true }, image: { type: 'text', required: true, placeholder: 'e.g., https://.../evt1.jpg' }, link: { type: 'url', required: true, placeholder: 'https://forms.gle/...' } } }; if (fieldMap[collectionName]) { for (const [key, config] of Object.entries(fieldMap[collectionName])) { const value = item?.[key] || ''; const requiredSpan = config.required ? ' <span class="text-red-500">*</span>' : ''; const requiredAttr = config.required ? ' required' : ''; const placeholder = config.placeholder ? ` placeholder="${config.placeholder}"` : ''; let fieldHtml = ''; if (config.type === 'textarea') { fieldHtml = `<textarea name="${key}" class="w-full p-2 border rounded input-field"${requiredAttr}>${value}</textarea>`; } else if (config.type === 'select') { const options = config.options.map(opt => `<option value="${opt}" ${value === opt ? 'selected' : ''}>${opt.charAt(0).toUpperCase() + opt.slice(1)}</option>`).join(''); fieldHtml = `<select name="${key}" class="w-full p-2 border rounded input-field"${requiredAttr}>${options}</select>`; } else { fieldHtml = `<input type="${config.type}" name="${key}" value="${value}" class="w-full p-2 border rounded input-field"${requiredAttr}${placeholder}>`; } fields += `<div><label class="capitalize block text-sm font-medium">${key}${requiredSpan}</label>${fieldHtml}</div>`; } } render.adminModal(`${docId ? 'Edit' : 'Add'} ${collectionName.slice(0, -1)}`, fields, 'admin-form'); document.getElementById('admin-form').addEventListener('submit', (e) => handlers.adminSave(e, collectionName, docId)); document.getElementById('close-modal-btn').addEventListener('click', () => dom.modalContainer.innerHTML = ''); },
            loadAlumniData: async (e) => { const year = e.target.value; const container = document.getElementById('alumni-data-container'); if (!year) { state.alumniYearData = []; container.innerHTML = '<p class="text-gray-500">Please select a year to display data.</p>'; return; } container.innerHTML = '<p class="text-gray-500">Loading data...</p>'; try { const response = await fetch(`alumni${year}.xlsx`); if (!response.ok) throw new Error('File not found'); const arrayBuffer = await response.arrayBuffer(); const data = new Uint8Array(arrayBuffer); const workbook = XLSX.read(data, { type: 'array' }); const sheetName = workbook.SheetNames[0]; const worksheet = workbook.Sheets[sheetName]; const jsonData = XLSX.utils.sheet_to_json(worksheet); state.alumniYearData = jsonData; render.alumniDataTable(jsonData); } catch (error) { utils.showToast(`Could not load data for ${year}. File might not exist.`, 'error'); container.innerHTML = `<p class="text-red-500">Could not load data for ${year}. Please ensure the file 'alumni${year}.xlsx' exists.</p>`; state.alumniYearData = []; } },
            searchAlumniData: (e) => { const query = e.target.value.toLowerCase(); if (!state.alumniYearData.length) return; const filteredData = state.alumniYearData.filter(row => Object.values(row).some(value => String(value).toLowerCase().includes(query))); render.alumniDataTable(filteredData); },
            downloadAlumniXLS: () => { if (state.alumniYearData.length === 0) { utils.showToast('No data to download.', 'error'); return; } const worksheet = XLSX.utils.json_to_sheet(state.alumniYearData); const workbook = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(workbook, worksheet, 'Alumni Data'); const year = document.getElementById('year-select').value || 'all'; XLSX.writeFile(workbook, `alumni_data_${year}.xlsx`); },
            callMargdarshakAi: async (e) => { e.preventDefault(); const input = document.getElementById('Margdarshak-input'); const userQuery = input.value.trim(); const apiKey = GEMINI_API_KEY; if (!apiKey) { utils.showToast('API key is not set. Please add it in the code.', 'error'); return; } if (!userQuery || state.isAiResponding) return; state.isAiResponding = true; state.MargdarshakHistory.push({ role: 'user', parts: [{ text: userQuery }] }); input.value = ''; input.disabled = true; render.app(); const historyForApi = state.MargdarshakHistory.map(h => ({ role: h.role, parts: h.parts })); const userName = state.userData?.displayName || 'student'; const userSkills = (state.userData?.skills || []).join(', ') || 'not specified'; const systemPrompt = `You are Margdarshak AI, a friendly and expert career counselor for students and alumni of the Dayalbagh Educational Institute (DEI), Agra. Your goal is to provide encouraging, insightful, and practical advice on technical topics, industry trends, and interview preparation. You are currently mentoring ${userName}, whose skills include: ${userSkills}. Tailor your advice to their skillset when appropriate. Be supportive and act as a mentor. Format your answers clearly: use bullet points (using a '-' character) for lists, and use bold markdown for emphasis on key terms (e.g., **Key Term**). Do not use any other markdown like asterisks for bullet points.`; try { const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`; const payload = { contents: historyForApi, systemInstruction: { parts: [{ text: systemPrompt }] } }; const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) }); if (!response.ok) { throw new Error(`API Error: ${response.statusText}`); } const result = await response.json(); let modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text; if (modelResponse) { let formattedResponse = modelResponse.replace(/\*\*(.*?)\*\*/g, '<b>$1</b>').replace(/^\s*-\s(.*)/gm, '<p class="ml-4">&bull; $1</p>').replace(/(\r\n|\n|\r)/gm, '<br>').replace(/<br><p/g, '<p').replace(/<\/p><br>/g, '</p>'); state.MargdarshakHistory.push({ role: 'model', parts: [{ text: formattedResponse }] }); } else { throw new Error('Invalid response structure from API.'); } } catch (error) { state.MargdarshakHistory.push({ role: 'model', parts: [{ text: `Sorry, I encountered an error: ${error.message}. Please check your API key and network.` }] }); utils.showToast(error.message, 'error'); } finally { state.isAiResponding = false; input.disabled = false; render.app(); input.focus(); if (state.currentUser) { const historyRef = doc(db, `artifacts/${appId}/users/${state.currentUser.uid}/MargdarshakHistory/main`); await setDoc(historyRef, { messages: state.MargdarshakHistory }); } } }
        };

        const addEventListeners = () => {
            document.getElementById('login-form')?.addEventListener('submit', (e) => handlers.authAction(e, true));
            document.getElementById('signup-form')?.addEventListener('submit', (e) => handlers.authAction(e, false));
            document.getElementById('show-signup')?.addEventListener('click', () => { state.currentPage = 'signup'; render.app(); });
            document.getElementById('show-login')?.addEventListener('click', () => { state.currentPage = 'login'; render.app(); });
            document.querySelectorAll('.role-btn').forEach(btn => btn.addEventListener('click', handlers.roleSelection));
            document.getElementById('profile-form')?.addEventListener('submit', handlers.profileCreate);
            document.getElementById('recruiter-profile-form')?.addEventListener('submit', handlers.recruiterProfileCreate);
            document.getElementById('profile-form')?.querySelector('#profile-faculty')?.addEventListener('change', (e) => utils.populateCourses(e.target.value, 'profile-course'));
            document.getElementById('profile-update-form')?.addEventListener('submit', handlers.profileUpdate);
            const facultyUpdateEl = document.getElementById('profile-faculty-update');
            if (facultyUpdateEl) { facultyUpdateEl.addEventListener('change', (e) => utils.populateCourses(e.target.value, 'profile-course-update')); if (state.userData && state.userData.faculty) { utils.populateCourses(state.userData.faculty, 'profile-course-update', state.userData.course); } }
            document.getElementById('logout-btn')?.addEventListener('click', handlers.logout);
            document.getElementById('logout-btn-mobile')?.addEventListener('click', handlers.logout);
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { state.currentPage = e.currentTarget.dataset.page; render.app(); }));
            document.querySelectorAll('.nav-link-mobile').forEach(link => { link.addEventListener('click', (e) => { document.getElementById('mobile-menu').classList.add('hidden'); state.currentPage = e.currentTarget.dataset.page; render.app(); }); });
            document.getElementById('mobile-menu-btn')?.addEventListener('click', () => { document.getElementById('mobile-menu').classList.toggle('hidden'); });
            const setupSearch = (inputId, resultsId) => { const searchInput = document.getElementById(inputId); const searchResults = document.getElementById(resultsId); if (searchInput) { searchInput.addEventListener('keyup', (e) => handlers.search(e.target.value, searchResults)); searchInput.addEventListener('blur', () => setTimeout(() => searchResults.classList.add('hidden'), 200)); searchInput.addEventListener('focus', (e) => handlers.search(e.target.value, searchResults)); } };
            setupSearch('search-bar', 'search-results'); setupSearch('search-bar-mobile', 'search-results-mobile');
            document.getElementById('recruiter-search-btn')?.addEventListener('click', handlers.recruiterSearch);
            document.getElementById('chat-form')?.addEventListener('submit', handlers.sendMessage);
            const closeModal = () => { state.viewingProfile = null; dom.modalContainer.innerHTML = ''; };
            document.getElementById('close-modal-btn')?.addEventListener('click', closeModal);
            const modalBackdrop = document.querySelector('.modal-backdrop');
            modalBackdrop?.addEventListener('click', (e) => { if (e.target === modalBackdrop) { closeModal(); } });
            document.querySelectorAll('.user-card, .applicant-name').forEach(card => card.addEventListener('click', (e) => handlers.viewProfile(e.currentTarget.dataset.userid)));
            document.getElementById('post-job-btn')?.addEventListener('click', () => { render.postJobModal(); document.getElementById('post-job-form').addEventListener('submit', handlers.postJob); document.getElementById('close-modal-btn').addEventListener('click', () => dom.modalContainer.innerHTML = ''); document.getElementById('post-job-modal-backdrop')?.addEventListener('click', (e) => { if (e.target.id === 'post-job-modal-backdrop') { dom.modalContainer.innerHTML = ''; } }); });
            document.querySelectorAll('.apply-btn').forEach(btn => btn.addEventListener('click', (e) => handlers.applyForJob(e.target.dataset.jobid)));
            document.querySelectorAll('.delete-job-btn').forEach(btn => btn.addEventListener('click', handlers.deleteJob));
            document.getElementById('delete-profile-btn')?.addEventListener('click', handlers.deleteProfile);
            document.getElementById('forgot-password-btn')?.addEventListener('click', () => { render.forgotPasswordModal(); document.getElementById('forgot-password-form').addEventListener('submit', handlers.forgotPassword); document.getElementById('close-modal-btn').addEventListener('click', () => dom.modalContainer.innerHTML = ''); document.getElementById('forgot-password-modal-backdrop')?.addEventListener('click', (e) => { if (e.target.id === 'forgot-password-modal-backdrop') { dom.modalContainer.innerHTML = ''; } }); });
            document.querySelectorAll('.admin-edit-user-btn').forEach(b => b.addEventListener('click', (e) => handlers.openAdminModal('users', e.target.dataset.userid)));
            document.querySelectorAll('.admin-delete-user-btn').forEach(b => b.addEventListener('click', (e) => handlers.adminDelete(e, 'users', e.target.dataset.userid)));
            document.getElementById('admin-add-job-btn')?.addEventListener('click', () => handlers.openAdminModal('jobs'));
            document.querySelectorAll('.admin-edit-job-btn').forEach(b => b.addEventListener('click', (e) => handlers.openAdminModal('jobs', e.target.dataset.jobid)));
            document.querySelectorAll('.admin-delete-job-btn').forEach(b => b.addEventListener('click', (e) => handlers.adminDelete(e, 'jobs', e.target.dataset.jobid)));
            document.getElementById('admin-add-event-btn')?.addEventListener('click', () => handlers.openAdminModal('events'));
            document.querySelectorAll('.admin-edit-event-btn').forEach(b => b.addEventListener('click', (e) => handlers.openAdminModal('events', e.target.dataset.eventid)));
            document.querySelectorAll('.admin-delete-event-btn').forEach(b => b.addEventListener('click', (e) => handlers.adminDelete(e, 'events', e.target.dataset.eventid)));
            document.querySelectorAll('.admin-delete-msg-btn').forEach(b => b.addEventListener('click', (e) => handlers.adminDelete(e, 'chats', e.target.dataset.msgid)));
            document.querySelectorAll('.mentor-email-btn, .mentor-linkedin-btn').forEach(b => b.addEventListener('click', handlers.requestMentorship));
            document.querySelectorAll('.resolve-mentorship-btn').forEach(b => b.addEventListener('click', handlers.resolveMentorship));
            const fresherCheckbox = document.getElementById('fresher-checkbox');
            const experienceContainer = document.getElementById('experience-field-container');
            if (fresherCheckbox && experienceContainer) { fresherCheckbox.addEventListener('change', (e) => { if (e.target.checked) { experienceContainer.style.display = 'none'; experienceContainer.querySelector('input').value = ''; } else { experienceContainer.style.display = 'block'; } }); }
            document.getElementById('year-select')?.addEventListener('change', handlers.loadAlumniData);
            document.getElementById('alumni-search')?.addEventListener('keyup', handlers.searchAlumniData);
            document.getElementById('download-alumni-xls')?.addEventListener('click', handlers.downloadAlumniXLS);
            document.getElementById('Margdarshak-form')?.addEventListener('submit', handlers.callMargdarshakAi);
        };

        const listenToUsers = () => onSnapshot(query(collection(db, `artifacts/${appId}/users`)), (snapshot) => { state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); state.isDataLoading = false; if (state.currentUser) { state.userData = state.users.find(u => u.id === state.currentUser.uid) || state.userData; } if (['dashboard', 'chat', 'admin', 'profile'].includes(state.currentPage) || state.userData?.role === 'Recruiter') render.app(); });
        const listenToChat = () => { const q = query(collection(db, `artifacts/${appId}/chats`), orderBy("timestamp", "asc")); onSnapshot(q, (snapshot) => { state.chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (state.currentPage === 'chat' || state.currentPage === 'admin') render.app(); }); };
        const listenToJobs = () => { const q = query(collection(db, `artifacts/${appId}/jobs`), orderBy("timestamp", "desc")); onSnapshot(q, (snapshot) => { state.jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (state.currentPage === 'jobs' || state.currentPage === 'admin' || (state.userData?.role === 'Recruiter' && state.currentPage === 'dashboard')) render.app(); }); }
        const listenToEvents = () => { const q = query(collection(db, `artifacts/${appId}/events`), orderBy("timestamp", "desc")); onSnapshot(q, (snapshot) => { state.events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (state.currentPage === 'dashboard' || state.currentPage === 'admin') render.app(); }); };
        const listenToMargdarshakHistory = () => { if (!state.currentUser) return; const historyRef = doc(db, `artifacts/${appId}/users`, state.currentUser.uid, 'MargdarshakHistory', 'main'); onSnapshot(historyRef, (docSnap) => { if (docSnap.exists() && docSnap.data().messages) { state.MargdarshakHistory = docSnap.data().messages; } else { state.MargdarshakHistory = []; } if (state.currentPage === 'MargdarshakAi') { render.app(); } }); };

        dom.loaderQuote.textContent = utils.getRandomQuote();

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.currentUser = user;
                state.isAdmin = adminEmails.includes(user.email);
                const userDoc = await getDoc(doc(db, `artifacts/${appId}/users/${user.uid}`));
                if (userDoc.exists()) {
                    state.userData = {id: user.uid, ...userDoc.data()};
                    if (state.isAdmin && state.userData.role !== 'Admin') { await updateDoc(doc(db, `artifacts/${appId}/users/${user.uid}`), { role: 'Admin' }); state.userData.role = 'Admin'; }
                    if (!state.userData.role) state.currentPage = 'selectRole';
                    else if (!state.userData.displayName) { if (state.isAdmin) state.userData.role = 'Admin'; state.currentPage = (state.userData.role === 'Recruiter' || state.userData.role === 'Admin') ? 'createRecruiterProfile' : 'createProfile'; }
                    else state.currentPage = 'dashboard';
                } else { state.userData = {}; state.currentPage = 'selectRole'; }
                listenToUsers();
                listenToChat();
                listenToJobs();
                listenToEvents();
                listenToMargdarshakHistory();
            } else { state.currentUser = null; state.userData = null; state.isAdmin = false; state.currentPage = 'login'; state.isDataLoading = false; }
            render.app();
        });
    </script>
</body>
</html>