<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AlmaLink - DEI Agra</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d9488;
            --primary-hover: #0f766e;
            --secondary-color: #f59e0b;
            --background-color: #f0fdfa;
            --text-color: #1f2937;
            --card-bg: #ffffff;
            --quote-color: #52525b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            overflow-x: hidden;
            background-image: linear-gradient(to top, #f0fdfa, #ffffff);
        }

        .page {
            animation: fadeIn 0.5s ease-in-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .btn-primary {
            background-color: var(--primary-color);
            transition: background-color 0.3s, transform 0.2s, box-shadow 0.3s;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 14px rgba(13, 148, 136, 0.3);
        }

        .input-field:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(13, 148, 136, 0.3);
        }

        .card {
            background-color: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -2px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s, box-shadow 0.3s, border-color 0.3s;
            border: 1px solid #e5e7eb;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.08);
            border-color: var(--primary-color);
        }

        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            animation: scaleUp 0.3s ease-in-out;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            max-height: 90vh;
            overflow-y: auto;
        }

        #search-results,
        #search-results-mobile {
            position: absolute;
            width: 100%;
            z-index: 10;
            max-height: 300px;
            overflow-y: auto;
            border-radius: 0 0 8px 8px;
            border: 1px solid #e5e7eb;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        @keyframes scaleUp {
            from {
                opacity: 0;
                transform: scale(0.95);
            }

            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        #loader-quote {
            min-height: 40px;
            animation: quoteFade 8s infinite;
        }

        @keyframes quoteFade {

            0%,
            20% {
                opacity: 1;
            }

            25%,
            95% {
                opacity: 0;
            }

            100% {
                opacity: 1;
            }
        }

        .skeleton-loader {
            background-color: #e5e7eb;
            border-radius: 8px;
            animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: .5;
            }
        }

        #alumni-data-table th,
        #alumni-data-table td {
            padding: 12px 15px;
            text-align: left;
        }

        .maargdarshak-bg {
            background-image: url('https://placehold.co/1920x1080/0d9488/0f766e/png?text=.');
            background-size: cover;
            background-position: center;
        }

        .chat-bubble-user {
            background-color: var(--primary-color);
            color: white;
        }

        .chat-bubble-model {
            background-color: #e5e7eb;
            color: var(--text-color);
        }

        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: var(--primary-color);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1.0);
            }
        }

        @keyframes blink {
            50% {
                opacity: 0;
            }
        }

        .badge-new {
            animation: blink 1.5s linear infinite;
        }
    </style>
</head>

<body class="antialiased">

   <div id="app-loader"
        class="fixed inset-0 bg-white flex flex-col items-center justify-center z-[100] text-center px-4">
        <img src="https://placehold.co/100x100/0d9488/FFFFFF/png?text=DEI" alt="DEI Logo" class="w-24 h-24 mb-4 rounded-full">
        <h1 class="text-3xl font-bold text-gray-800">AlmaLink - DEI</h1>
        <p id="loader-quote" class="mt-4 text-lg text-[var(--quote-color)]"></p>
        <div class="mt-4 border-gray-300 h-8 w-8 animate-spin rounded-full border-4 border-t-[var(--primary-color)]">
        </div>
    </div>

    <div id="app-container" class="min-h-screen"></div>
    <div id="modal-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, deleteUser, sendPasswordResetEmail, reauthenticateWithCredential, EmailAuthProvider } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, addDoc, serverTimestamp, orderBy, updateDoc, arrayUnion, deleteDoc, increment } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration ---
       const firebaseConfig = {
  apiKey: "AIzaSyD5KFbouIqFTkzeHGL3IGavdGLM3OjwWBI",
  authDomain: "deioldgems.firebaseapp.com",
  projectId: "deioldgems",
  storageBucket: "deioldgems.firebasestorage.app",
  messagingSenderId: "933183653419",
  appId: "1:933183653419:web:9ba92d801f60aa68c78c6e",
  measurementId: "G-3J4YDNM1MY"
};

const GEMINI_API_KEY = "AIzaSyDgHqrrTXR8apwWUxJSomJgw-BODNFoC-E"; // IMPORTANT: Add your Gemini API Key
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = "alumnideiagra"; 
        setPersistence(auth, browserLocalPersistence);

        const adminEmails = ["admin@dei.com"];
        const state = { currentUser: null, userData: null, users: [], jobs: [], events: [], chatMessages: [], currentPage: 'loading', viewingProfile: null, isDataLoading: true, isAdmin: false, alumniYearData: [], maargdarshakHistory: [], isAiResponding: false };
        const quotes = ["Connecting roots, growing futures.", "From classrooms to careers, our bond remains.", "Mentorship is the bridge between experience and aspiration.", "Our alumni are the pillars of our legacy.", "Your alumni network is one of your greatest assets."];
        const deiCourses = { "Faculty of Engineering": ["B.Tech. Electrical Engineering", "B.Tech. Mechanical Engineering", "B.Tech. Civil Engineering", "B.Tech. Computer Science", "B.Tech. Footwear Technology"], "Faculty of Science": ["B.Sc. (Hons.) Mathematics", "B.Sc. (Hons.) Physics", "B.Sc. (Hons.) Chemistry", "B.Sc. (Hons.) Computer Science", "B.Sc. (Hons.) Zoology", "B.Sc. (Hons.) Botany"], "Faculty of Arts": ["B.A. (Hons.) English", "B.A. (Hons.) Hindi", "B.A. (Hons.) Music", "B.A. (Hons.) Drawing & Painting", "B.A. (Hons.) Home Science"], "Faculty of Commerce": ["B.Com. (Hons.)", "M.Com."], "Faculty of Social Science": ["B.A. (Hons.) Political Science", "B.A. (Hons.) Sociology", "B.A. (Hons.) Psychology", "B.A. (Hons.) Economics"], "Faculty of Architecture": ["B.Arch."] };
        const inappropriateWords = ["abuse", "idiot", "stupid", "hate", "kill", "dumb", "fool"];
        const recruiterVerificationCodes = ["DEI-RC-A8F2", "DEI-RC-9G3H", "DEI-RC-B4K5", "DEI-RC-C1L9", "DEI-RC-D7M3"];

        const dom = { appContainer: document.getElementById('app-container'), appLoader: document.getElementById('app-loader'), modalContainer: document.getElementById('modal-container'), loaderQuote: document.getElementById('loader-quote') };

        const utils = {
            showToast: (message, type = 'success') => { const toast = document.createElement('div'); toast.className = `fixed bottom-5 right-5 text-white px-6 py-3 rounded-lg shadow-2xl z-[101] animate-fadeIn ${type === 'success' ? 'bg-green-500' : 'bg-red-500'}`; toast.textContent = message; document.body.appendChild(toast); setTimeout(() => { toast.style.animation = 'fadeOut 0.5s'; setTimeout(() => toast.remove(), 500); }, 3000); },
            getProfileImageUrl: (user) => { if (user) { if (user.role === 'Student') return 'https://placehold.co/100x100/34d399/FFFFFF/png?text=S'; if (user.role === 'Alumni') return 'https://placehold.co/100x100/60a5fa/FFFFFF/png?text=A'; if (user.role === 'Recruiter') return 'https://placehold.co/100x100/c084fc/FFFFFF/png?text=R'; if (user.role === 'Admin') return `https://placehold.co/100x100/4f46e5/ffffff?text=ADM`; } return 'https://placehold.co/100x100/E0E7FF/4338CA?text=?'; },
            getRandomQuote: () => quotes[Math.floor(Math.random() * quotes.length)],
            populateCourses: (faculty, courseElementId, selectedCourse = '') => { const courseSelect = document.getElementById(courseElementId); if (!courseSelect) return; courseSelect.innerHTML = '<option value="">Select Course</option>'; if (faculty && deiCourses[faculty]) { deiCourses[faculty].forEach(course => { const option = document.createElement('option'); option.value = course; option.textContent = course; if (course === selectedCourse) option.selected = true; courseSelect.appendChild(option); }); courseSelect.disabled = false; } else { courseSelect.disabled = true; } },
            getRoleBadge: (role) => { const roles = { 'Student': 'bg-blue-100 text-blue-800', 'Alumni': 'bg-green-100 text-green-800', 'Recruiter': 'bg-purple-100 text-purple-800', 'Admin': 'bg-yellow-100 text-yellow-800' }; return `<span class="text-xs font-medium ml-2 px-2 py-0.5 rounded-full ${roles[role] || ''}">${role}</span>`; },
            getMentorshipBadge: (count) => {
                if (count >= 100) return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-amber-500 text-white" title="Mentored 100+ students">ðŸ’Ž Diamond Mentor</span>`;
                if (count >= 50) return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-700 text-white" title="Mentored 50+ students">Platinum Mentor</span>`;
                if (count >= 20) return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-400 text-yellow-800" title="Mentored 20+ students">Gold Mentor</span>`;
                if (count >= 10) return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-300 text-gray-800" title="Mentored 10+ students">Silver Mentor</span>`;
                if (count >= 5) return `<span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-300 text-orange-800" title="Mentored 5+ students">Bronze Mentor</span>`;
                return '';
            }
        };

        const render = {
            navbar: () => {
                if (!state.currentUser || !state.userData) return '';
                const maargdarshakLink = `<button data-page="maargdarshakAi" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100 relative">Maargdarshak <span class="absolute top-0 right-0 -mt-1 -mr-1 px-2 py-0.5 bg-red-500 rounded-full text-xs font-bold text-white badge-new">NEW</span></button>`;
                const maargdarshakLinkMobile = `<button data-page="maargdarshakAi" class="nav-link-mobile block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100 relative">Maargdarshak <span class="absolute top-1 right-1 px-2 py-0.5 bg-red-500 rounded-full text-xs font-bold text-white badge-new">NEW</span></button>`;
                const saarthiLink = state.userData.role === 'Student' ? `<button data-page="saarthi" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Saarthi</button>` : '';
                const saarthiLinkMobile = state.userData.role === 'Student' ? `<button data-page="saarthi" class="nav-link-mobile block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Saarthi</button>` : '';
                const baseLinks = `<button data-page="dashboard" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Dashboard</button><button data-page="alumniData" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Alumni Data</button>${maargdarshakLink}${saarthiLink}`;
                const baseLinksMobile = `<button data-page="dashboard" class="nav-link-mobile block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Dashboard</button><button data-page="alumniData" class="nav-link-mobile block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Alumni Data</button>${maargdarshakLinkMobile}${saarthiLinkMobile}`;
                const jobBoardLink = state.userData.role !== 'Recruiter' ? `<button data-page="jobs" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Job Board</button>` : '';
                const jobBoardLinkMobile = state.userData.role !== 'Recruiter' ? `<button data-page="jobs" class="nav-link-mobile block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Job Board</button>` : '';
                const adminLink = state.isAdmin ? `<button data-page="admin" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-yellow-700 hover:bg-yellow-100">Admin Panel</button>` : '';
                const adminLinkMobile = state.isAdmin ? `<button data-page="admin" class="nav-link-mobile block w-full text-left px-3 py-2 rounded-md text-base font-medium text-yellow-700 hover:bg-yellow-100">Admin Panel</button>` : '';
                return `<nav class="bg-white shadow-md sticky top-0 z-40"><div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8"><div class="flex items-center justify-between h-16"><div class="flex items-center"><div class="flex-shrink-0 w-10 h-10 flex items-center justify-center"><img src="https://placehold.co/100x100/0d9488/FFFFFF/png?text=DEI" alt="Logo" class="w-10 h-10 rounded-full"></div><span class="ml-3 font-bold text-xl text-gray-800">AlmaLink</span></div><div class="hidden md:flex items-center space-x-4"><div class="relative flex-1 max-w-xs"><input id="search-bar" type="text" placeholder="Search users..." class="w-full px-4 py-2 rounded-md border border-gray-300 input-field" autocomplete="off"><div id="search-results" class="hidden absolute mt-1 w-full bg-white rounded-md shadow-lg overflow-hidden"></div></div>${baseLinks}${jobBoardLink}<button data-page="profile" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Profile</button><button data-page="chat" class="nav-link px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-100">Chat</button>${adminLink}<button id="logout-btn" class="btn-primary text-white px-4 py-2 rounded-md text-sm font-medium">Logout</button></div><div class="md:hidden"><button id="mobile-menu-btn" class="text-gray-700 hover:text-teal-600 p-2 rounded-md"><svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg></button></div></div></div><div id="mobile-menu" class="md:hidden hidden bg-white border-t"><div class="px-2 pt-2 pb-3 space-y-1 sm:px-3"><div class="relative w-full p-2"><input id="search-bar-mobile" type="text" placeholder="Search users..." class="w-full px-4 py-2 rounded-md border border-gray-300 input-field" autocomplete="off"><div id="search-results-mobile" class="hidden absolute mt-1 w-full bg-white rounded-md shadow-lg overflow-hidden"></div></div>${baseLinksMobile}${jobBoardLinkMobile}<button data-page="profile" class="nav-link-mobile block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Profile</button><button data-page="chat" class="nav-link-mobile block w-full text-left px-3 py-2 rounded-md text-base font-medium text-gray-700 hover:bg-gray-100">Chat</button>${adminLinkMobile}<button id="logout-btn-mobile" class="mt-2 w-full text-left btn-primary text-white px-3 py-2 rounded-md text-base font-medium">Logout</button></div></div></nav>`;
            },
            authPage: (isLogin) => { const title = isLogin ? "Sign in to your account" : "Create a new account"; const subtext = isLogin ? "Welcome back! Please enter your details." : "Join our community! Let's get you set up."; const forgotPasswordLink = isLogin ? `<div class="text-sm text-right"><button id="forgot-password-btn" class="font-medium text-teal-600 hover:text-teal-500">Forgot password?</button></div>` : ''; return `<div class="page min-h-screen grid grid-cols-1 lg:grid-cols-2"><div class="hidden lg:flex flex-col items-center justify-center bg-teal-600 text-white p-12 text-center"><h1 class="text-4xl font-bold mb-4">Welcome to AlmaLink DEI</h1><p class="text-lg text-teal-100">"${utils.getRandomQuote()}"</p></div><div class="flex items-center justify-center bg-gray-50"><div class="max-w-md w-full space-y-8 p-10 bg-white rounded-xl shadow-lg"><div class="text-center"><div class="mx-auto w-20 h-20 flex items-center justify-center mb-4"><img src="https://placehold.co/100x100/0d9488/FFFFFF/png?text=DEI" alt="Logo" class="w-20 h-20 rounded-full"></div><h2 class="text-3xl font-extrabold text-gray-900">${title}</h2><p class="mt-2 text-sm text-gray-600">${subtext}</p></div><form id="${isLogin ? 'login' : 'signup'}-form" class="mt-8 space-y-6"><div class="rounded-md shadow-sm -space-y-px"><div><input id="${isLogin ? 'login' : 'signup'}-email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-t-md focus:outline-none input-field sm:text-sm" placeholder="Email address"></div><div><input id="${isLogin ? 'login' : 'signup'}-password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-3 border border-gray-300 placeholder-gray-500 text-gray-900 rounded-b-md focus:outline-none input-field sm:text-sm" placeholder="Password"></div></div>${forgotPasswordLink}<div><button type="submit" class="group relative w-full flex justify-center py-3 px-4 border border-transparent text-sm font-medium rounded-md text-white btn-primary">${isLogin ? 'Sign in' : 'Sign up'}</button></div></form><p class="text-center text-sm text-gray-600">${isLogin ? "Don't have an account?" : "Already have an account?"} <button id="${isLogin ? 'show-signup' : 'show-login'}" class="font-medium text-teal-600 hover:text-teal-500">${isLogin ? "Sign up" : "Sign in"}</button></p></div></div></div>`; },
            roleSelectionPage: () => `<div class="page min-h-screen flex items-center justify-center"><div class="max-w-lg w-full text-center p-8 bg-white rounded-xl shadow-lg"><h2 class="text-2xl font-bold mb-6">Welcome! Choose your role.</h2><div class="grid grid-cols-1 md:grid-cols-3 gap-4"><button data-role="Student" class="role-btn p-6 border rounded-lg hover:bg-teal-50 transition">Student</button><button data-role="Alumni" class="role-btn p-6 border rounded-lg hover:bg-teal-50 transition">Alumni</button><button data-role="Recruiter" class="role-btn p-6 border rounded-lg hover:bg-teal-50 transition">Recruiter</button></div></div></div>`,
            studentAlumniProfileCreationPage: () => { 
                const facultyOptions = Object.keys(deiCourses).map(f => `<option value="${f}">${f}</option>`).join(''); 
                const mentorshipCheckbox = state.userData.role === 'Alumni' 
                    ? `<div class="flex items-center mt-4">
                            <input id="open-to-mentorship" type="checkbox" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500">
                            <label for="open-to-mentorship" class="ml-2 block text-sm text-gray-900">Open to Mentorship</label>
                       </div>` 
                    : '';
                return `<div class="page min-h-screen flex items-center justify-center py-12"><div class="max-w-2xl w-full p-8 bg-white rounded-xl shadow-lg space-y-6"><h2 class="text-2xl font-bold text-center">Complete Your Profile</h2><form id="profile-form" class="space-y-4"><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Full Name <span class="text-red-500">*</span></label><input id="profile-name" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Gender <span class="text-red-500">*</span></label><div class="mt-2 flex gap-4"><label class="flex items-center"><input type="radio" name="gender" value="Male" required class="h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"><span class="ml-2">Male</span></label><label class="flex items-center"><input type="radio" name="gender" value="Female" class="h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"><span class="ml-2">Female</span></label></div></div></div><div><label class="block text-sm font-medium">Faculty <span class="text-red-500">*</span></label><select id="profile-faculty" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"><option value="">Select Faculty</option>${facultyOptions}</select></div><div><label class="block text-sm font-medium">Course <span class="text-red-500">*</span></label><select id="profile-course" required disabled class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field bg-gray-50"><option value="">Select Course</option></select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label class="block text-sm font-medium">Start Year <span class="text-red-500">*</span></label><input id="profile-start-year" type="number" placeholder="YYYY" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" min="1900" max="2025"></div><div><label class="block text-sm font-medium">End Year <span class="text-red-500">*</span></label><input id="profile-end-year" type="number" placeholder="YYYY" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" min="1900" max="2030"></div></div><div><label class="block text-sm font-medium">Headline (e.g., Software Engineer at Google)</label><input id="profile-headline" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div class="space-y-4 border-t pt-4"><h3 class="text-md font-semibold text-gray-700">Work Experience</h3><div class="flex items-center"><input id="fresher-checkbox" type="checkbox" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500"><label for="fresher-checkbox" class="ml-2 block text-sm text-gray-900">I am a Fresher</label></div><div id="experience-field-container"><label class="block text-sm font-medium">Year of Joining First Job</label><input id="profile-joining-year" type="number" placeholder="YYYY" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div></div><div><label class="block text-sm font-medium">Skills (comma-separated)</label><p class="text-xs text-gray-500 italic">Fill carefully, as this helps recruiters find you.</p><input id="profile-skills" type="text" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" placeholder="e.g., React, Node.js, Python"></div><div><label class="block text-sm font-medium">LinkedIn Profile URL</label><input id="profile-linkedin" type="url" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">GitHub Profile URL</label><input id="profile-github" type="url" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div>${mentorshipCheckbox}<button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Save Profile</button></form></div></div>`; 
            },
            recruiterProfileCreationPage: () => { return `<div class="page min-h-screen flex items-center justify-center py-12"><div class="max-w-2xl w-full p-8 bg-white rounded-xl shadow-lg space-y-6"><h2 class="text-2xl font-bold text-center">Complete Your Recruiter Profile</h2><form id="recruiter-profile-form" class="space-y-4"><div><label class="block text-sm font-medium">Full Name <span class="text-red-500">*</span></label><input id="recruiter-name" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Gender <span class="text-red-500">*</span></label><div class="mt-2 flex gap-4"><label class="flex items-center"><input type="radio" name="gender" value="Male" required class="h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"><span class="ml-2">Male</span></label><label class="flex items-center"><input type="radio" name="gender" value="Female" class="h-4 w-4 text-teal-600 border-gray-300 focus:ring-teal-500"><span class="ml-2">Female</span></label></div></div><div><label class="block text-sm font-medium">Organization Name <span class="text-red-500">*</span></label><input id="recruiter-organization" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Your Job Title (e.g., HR Manager) <span class="text-red-500">*</span></label><input id="recruiter-headline" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Organization Website</label><input id="recruiter-website" type="url" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Verification Code <span class="text-red-500">*</span></label><input id="recruiter-verification-code" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Save Profile</button></form></div></div>`; },
            dashboard: () => { const { role, displayName } = state.userData; const skeletonCard = `<div class="card p-4"><div class="flex items-center space-x-4"><div class="w-16 h-16 rounded-full skeleton-loader"></div><div class="flex-1 space-y-2"><div class="w-3/4 h-4 skeleton-loader"></div><div class="w-1/2 h-4 skeleton-loader"></div></div></div></div>`; const eventsContent = (type) => { const filteredEvents = state.events.filter(e => e.type === type); const eventCards = filteredEvents.length > 0 ? filteredEvents.map(event => `<div class="card overflow-hidden group flex flex-col"><div class="overflow-hidden"><img src="${event.image}" alt="${event.title}" class="w-full h-48 object-cover group-hover:scale-105 transition-transform duration-300"></div><div class="p-5 flex flex-col flex-grow"><h4 class="font-bold text-lg text-teal-700">${event.title}</h4><p class="text-sm text-gray-500 mb-2">${new Date(event.date).toDateString()}</p><p class="text-gray-700 text-sm flex-grow">${event.description}</p><a href="${event.link}" target="_blank" rel="noopener noreferrer" class="mt-4 text-center btn-primary text-white px-4 py-2 rounded-md text-sm font-medium">Register Now</a></div></div>`).join('') : '<p class="text-gray-500 col-span-full">No upcoming events of this type.</p>'; return `<div class="mt-8"><h3 class="text-xl font-semibold mb-4">${type === 'college' ? 'Upcoming College Events' : 'Alumni Reunion Events'}</h3><div class="grid grid-cols-1 lg:grid-cols-2 gap-6">${eventCards}</div></div>`; }; let content = ''; if (state.isDataLoading) { content = `<div class="mt-8 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">${skeletonCard.repeat(6)}</div>`; } else if (role === 'Student' || role === 'Alumni') { const mentors = state.users.filter(u => u.role === 'Alumni' && u.id !== state.currentUser.uid).sort(() => 0.5 - Math.random()).slice(0, 6); content = `<div class="grid grid-cols-1 xl:grid-cols-3 gap-8"><div class="xl:col-span-2">${eventsContent('college')} ${role === 'Alumni' ? eventsContent('reunion') : ''}</div><div class="space-y-6"><div class="card p-5 bg-teal-50 border-teal-200"><h3 class="font-bold text-teal-800">Quote of the Day</h3><p class="mt-2 text-teal-700 italic">"${utils.getRandomQuote()}"</p></div><h3 class="text-xl font-semibold">Mentor Suggestions</h3>${mentors.length > 0 ? mentors.map(m => `<div class="card p-4 flex items-center space-x-4 user-card cursor-pointer" data-userid="${m.id}"><img src="${utils.getProfileImageUrl(m)}" class="w-16 h-16 rounded-full flex-shrink-0 object-cover"><div><h4 class="font-bold">${m.displayName}</h4><p class="text-sm text-gray-600">${m.headline || 'Alumni'}</p></div></div>`).join('') : '<p>No alumni mentors found.</p>'}</div></div>`; } else if (role === 'Recruiter') { const myJobs = state.jobs.filter(job => job.postedBy === state.currentUser.uid); const myJobsHtml = myJobs.length > 0 ? myJobs.map(job => { const applicants = job.applicants?.map(appId => state.users.find(u => u.id === appId)).filter(Boolean) || []; return `<div class="card p-4"><div class="flex justify-between items-start"><div><h4 class="font-bold text-teal-700">${job.title}</h4><p class="text-sm text-gray-500">${job.location}</p></div><button data-jobid="${job.id}" data-confirm="false" class="delete-job-btn text-sm text-red-500 hover:text-red-700 font-semibold px-3 py-1 rounded-md transition-colors bg-red-50 hover:bg-red-100">Delete</button></div><div class="mt-4"><h5 class="text-sm font-semibold">Applicants (${applicants.length})</h5><div class="mt-2 text-sm max-h-24 overflow-y-auto">${applicants.length > 0 ? applicants.map(a => `<p class="applicant-name cursor-pointer hover:underline" data-userid="${a.id}">${a.displayName}</p>`).join('') : '<p class="text-gray-400">No applicants yet.</p>'}</div></div></div>` }).join('') : '<p class="text-gray-500 col-span-full">You have not posted any jobs yet.</p>'; content = `<div><div class="grid grid-cols-1 lg:grid-cols-2 gap-8"><div><div class="flex justify-between items-center mb-4"><h3 class="text-xl font-semibold">Find Talent</h3><button id="post-job-btn" class="btn-primary text-white px-6 py-2 rounded-md">Post a Job</button></div><div class="bg-white p-4 rounded-lg shadow-sm flex flex-col md:grid md:grid-cols-3 gap-4"><input id="recruiter-search-name" type="text" placeholder="Search by name..." class="md:col-span-1 px-3 py-2 border rounded-md input-field"><input id="recruiter-search-skill" type="text" placeholder="Filter by skill..." class="md:col-span-1 px-3 py-2 border rounded-md input-field"><input id="recruiter-search-exp" type="number" placeholder="Min. experience (years)" class="md:col-span-1 px-3 py-2 border rounded-md input-field"><button id="recruiter-search-btn" class="md:col-span-3 btn-primary text-white px-6 py-2 rounded-md">Search</button></div><div id="recruiter-results" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6"><p class="text-gray-500 col-span-full">Search for candidates above.</p></div></div><div><h3 class="text-xl font-semibold mb-4">Your Job Postings</h3><div class="space-y-4">${myJobsHtml}</div></div></div></div>`; } return `<div class="page max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold text-gray-900">Welcome, ${displayName}!</h1><p class="text-gray-600">Your ${role} Dashboard</p>${content}</div>`; },
            profilePage: () => {
                const user = state.userData;
                if (!user) return render.dashboard();
                const deleteProfileButton = `<div class="mt-8 pt-6 border-t border-gray-200"><h3 class="text-lg font-medium text-red-600">Danger Zone</h3><p class="mt-1 text-sm text-gray-500">Deleting your profile is permanent and cannot be undone.</p><button id="delete-profile-btn" data-confirm="false" class="mt-4 inline-flex items-center justify-center px-4 py-2 border border-transparent text-sm font-medium rounded-md text-white bg-red-600 hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 transition-colors">Delete My Profile</button></div>`;
                
                const mentoredByAlumni = state.users.find(u => u.id === user.mentoredBy);
                const spotlightSection = user.role === 'Student' && user.mentoredBy ? `
                    <div class="mt-6 p-4 bg-yellow-100 border border-yellow-300 rounded-lg text-center">
                        <h3 class="text-lg font-semibold text-yellow-800">ðŸŒŸ Spotlight Medal ðŸŒŸ</h3>
                        <p class="text-yellow-700">Helped by <span class="font-bold">${mentoredByAlumni ? mentoredByAlumni.displayName : 'an alumnus'}</span>!</p>
                    </div>` : '';

                if (user.role === 'Recruiter' || user.role === 'Admin') {
                    return `<div class="page max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8"><div class="card p-8"><form id="profile-update-form"><div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-8"><img src="${utils.getProfileImageUrl(user)}" alt="Profile Picture" class="w-24 h-24 rounded-full flex-shrink-0 object-cover"><div class="flex-grow text-center sm:text-left"><h2 class="text-2xl font-bold">${user.displayName}</h2><p class="text-gray-500">${user.headline || user.role}</p></div><button type="submit" class="btn-primary text-white px-6 py-2 rounded-md">Save Changes</button></div><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><label class="block text-sm font-medium">Full Name</label><input id="profile-name-update" type="text" value="${user.displayName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Job Title</label><input id="profile-headline-update" type="text" value="${user.headline || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div class="md:col-span-2"><label class="block text-sm font-medium">Organization</label><input id="profile-organization-update" type="text" value="${user.organizationName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div class="md:col-span-2"><label class="block text-sm font-medium">Website</label><input id="profile-website-update" type="url" value="${user.website || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div></div></form>${deleteProfileButton}</div></div>`;
                }

                const facultyOptions = Object.keys(deiCourses).map(f => `<option value="${f}" ${user.faculty === f ? 'selected' : ''}>${f}</option>`).join('');
                const mentorshipCheckbox = user.role === 'Alumni' 
                    ? `<div class="md:col-span-2 flex items-center mt-4">
                            <input id="open-to-mentorship-update" type="checkbox" class="h-4 w-4 text-teal-600 border-gray-300 rounded focus:ring-teal-500" ${user.openToMentorship ? 'checked' : ''}>
                            <label for="open-to-mentorship-update" class="ml-2 block text-sm text-gray-900">Open to Mentorship</label>
                       </div>` 
                    : '';

                return `<div class="page max-w-4xl mx-auto py-12 px-4 sm:px-6 lg:px-8"><div class="card p-8"><form id="profile-update-form"><div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-8"><img src="${utils.getProfileImageUrl(user)}" alt="Profile Picture" class="w-24 h-24 rounded-full flex-shrink-0 object-cover"><div class="flex-grow text-center sm:text-left"><h2 class="text-2xl font-bold">${user.displayName}</h2><p class="text-gray-500">${user.role}</p><div class="mt-2">${utils.getMentorshipBadge(user.mentorshipRequests || 0)}</div></div><button type="submit" class="btn-primary text-white px-6 py-2 rounded-md">Save Changes</button></div>${spotlightSection}<div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-6"><div><label class="block text-sm font-medium">Full Name</label><input id="profile-name-update" type="text" value="${user.displayName || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Headline</label><input id="profile-headline-update" type="text" value="${user.headline || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Faculty</label><select id="profile-faculty-update" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field">${facultyOptions}</select></div><div><label class="block text-sm font-medium">Course</label><select id="profile-course-update" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></select></div><div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:col-span-2"><div><label class="block text-sm font-medium">Start Year</label><input id="profile-start-year-update" type="number" placeholder="YYYY" value="${user.startYear || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" min="1900" max="2025"></div><div><label class="block text-sm font-medium">End Year</label><input id="profile-end-year-update" type="number" placeholder="YYYY" value="${user.endYear || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" min="1900" max="2030"></div></div><div class="md:col-span-2"><label class="block text-sm font-medium">Year of Joining First Job</label><input id="profile-joining-year-update" type="number" value="${user.yearOfJoining || ''}" placeholder="YYYY" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div class="md:col-span-2"><label class="block text-sm font-medium">Skills (comma-separated)</label><p class="text-xs text-gray-500 italic">Fill carefully, as this helps recruiters find you.</p><input id="profile-skills-update" type="text" value="${(user.skills || []).join(', ')}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">LinkedIn URL</label><input id="profile-linkedin-update" type="url" value="${user.linkedin || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">GitHub URL</label><input id="profile-github-update" type="url" value="${user.github || ''}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div>${mentorshipCheckbox}</div></form>${deleteProfileButton}</div></div>`;
            },
            chatPage: () => `<div class="page max-w-7xl mx-auto py-8 px-4 sm:px-6 lg:px-8 h-[calc(100vh-64px)] flex flex-col"><h1 class="text-3xl font-bold mb-4">Global Chat Room</h1><div id="chat-box" class="flex-grow bg-white border rounded-lg p-4 overflow-y-auto mb-4 flex flex-col space-y-2">${state.chatMessages.map(msg => { const isMe = msg.uid === state.currentUser.uid; const user = state.users.find(u => u.id === msg.uid); return `<div class="flex items-end gap-2 ${isMe ? 'flex-row-reverse' : ''}"><img src="${utils.getProfileImageUrl(user)}" class="w-8 h-8 rounded-full"><div class="max-w-xs lg:max-w-md p-3 rounded-lg ${isMe ? 'bg-teal-500 text-white rounded-br-none' : 'bg-gray-200 text-gray-800 rounded-bl-none'}"><p class="font-bold text-sm flex items-center">${isMe ? 'You' : msg.displayName} ${user ? utils.getRoleBadge(user.role) : ''}</p><p class="mt-1 break-words">${msg.text}</p><p class="text-xs text-right opacity-70 mt-1">${msg.timestamp ? new Date(msg.timestamp.toDate()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : ''}</p></div></div>`; }).join('')}</div><form id="chat-form" class="flex gap-4"><input id="chat-input" type="text" placeholder="Type a message..." required class="flex-grow px-4 py-2 border rounded-lg input-field"><button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Send</button></form></div>`,
            jobBoardPage: () => { const jobList = state.jobs.map(job => { const hasApplied = job.applicants && job.applicants.includes(state.currentUser.uid); const recruiter = state.users.find(u => u.id === job.postedBy); return `<div class="card p-5 flex flex-col"><div class="flex justify-between items-start"><div><h3 class="text-lg font-bold text-teal-700">${job.title}</h3><p class="text-sm font-medium text-gray-600">${recruiter?.organizationName || job.company}</p><p class="text-sm text-gray-500">${job.location}</p></div><img src="${utils.getProfileImageUrl(recruiter)}" class="w-12 h-12 rounded-full object-cover"></div><p class="text-sm text-gray-700 mt-4 whitespace-pre-wrap flex-grow">${job.description}</p><div class="mt-4"><button data-jobid="${job.id}" class="w-full text-center btn-primary text-white px-4 py-2 rounded-md text-sm font-medium apply-btn" ${hasApplied ? 'disabled' : ''}>${hasApplied ? 'Applied' : 'Apply Now'}</button></div></div>` }).join(''); return `<div class="page max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold text-gray-900">Job Board</h1><p class="text-gray-600">Opportunities posted by our network of recruiters.</p><div class="mt-8 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">${state.jobs.length > 0 ? jobList : '<p class="col-span-full text-center text-gray-500">No job openings at the moment. Check back later!</p>'}</div></div>`; },
            adminPage: () => { const managementCard = (title, content, buttonId, buttonText) => `<div class="card p-6"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-semibold">${title}</h2>${buttonId ? `<button id="${buttonId}" class="btn-primary text-white px-4 py-2 text-sm rounded-md">${buttonText}</button>` : ''}</div><div class="overflow-x-auto">${content}</div></div>`; const usersTable = `<table class="w-full text-sm text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-2 font-semibold">Name</th><th class="p-2 font-semibold">Email</th><th class="p-2 font-semibold">Role</th><th class="p-2 font-semibold">Actions</th></tr></thead><tbody>${state.users.map(user => `<tr class="border-b"><td class="p-2">${user.displayName}</td><td class="p-2">${user.email}</td><td class="p-2">${user.role}</td><td class="p-2"><button class="admin-edit-user-btn text-blue-500 hover:underline" data-userid="${user.id}">Edit</button><button class="admin-delete-user-btn text-red-500 hover:underline ml-4" data-userid="${user.id}">Delete</button></td></tr>`).join('')}</tbody></table>`; const messagesList = `<ul class="divide-y">${state.chatMessages.map(msg => `<li class="py-2 flex justify-between items-center"><span><b>${msg.displayName}:</b> ${msg.text}</span><button class="admin-delete-msg-btn text-red-500 hover:underline" data-msgid="${msg.id}">Delete</button></li>`).join('') || '<li>No messages.</li>'}</ul>`; const jobsTable = `<table class="w-full text-sm text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-2 font-semibold">Title</th><th class="p-2 font-semibold">Company</th><th class="p-2 font-semibold">Actions</th></tr></thead><tbody>${state.jobs.map(job => `<tr class="border-b"><td class="p-2">${job.title}</td><td class="p-2">${job.company}</td><td class="p-2"><button class="admin-edit-job-btn text-blue-500 hover:underline" data-jobid="${job.id}">Edit</button><button class="admin-delete-job-btn text-red-500 hover:underline ml-4" data-jobid="${job.id}">Delete</button></td></tr>`).join('')}</tbody></table>`; const eventsTable = `<table class="w-full text-sm text-left"><thead><tr class="bg-gray-50 border-b"><th class="p-2 font-semibold">Title</th><th class="p-2 font-semibold">Date</th><th class="p-2 font-semibold">Type</th><th class="p-2 font-semibold">Actions</th></tr></thead><tbody>${state.events.map(event => `<tr class="border-b"><td class="p-2">${event.title}</td><td class="p-2">${event.date}</td><td class="p-2">${event.type}</td><td class="p-2"><button class="admin-edit-event-btn text-blue-500 hover:underline" data-eventid="${event.id}">Edit</button><button class="admin-delete-event-btn text-red-500 hover:underline ml-4" data-eventid="${event.id}">Delete</button></td></tr>`).join('')}</tbody></table>`; return `<div class="page max-w-7xl mx-auto py-8 px-4"><h1 class="text-3xl font-bold mb-6">Admin Dashboard</h1><div class="space-y-8">${managementCard('User Management', usersTable, null, null)}${managementCard('Job Postings', jobsTable, 'admin-add-job-btn', 'Add Job')}${managementCard('Event Management', eventsTable, 'admin-add-event-btn', 'Add Event')}<div class="card p-6"><h2 class="text-xl font-semibold mb-4">Recent Messages</h2>${messagesList}</div></div></div>`; },
            adminModal: (title, formHtml, formId) => { dom.modalContainer.innerHTML = `<div class="modal-backdrop"><div class="modal-content"><div class="flex justify-between items-center mb-4"><h2 class="text-2xl font-bold">${title}</h2><button id="close-modal-btn" class="text-gray-500 text-3xl">&times;</button></div><form id="${formId}" class="space-y-4">${formHtml}<button type="submit" class="btn-primary text-white w-full py-2 rounded-md mt-4">Save</button></form></div></div>`; },
            userProfileModal: (user) => { 
                if (!user) { dom.modalContainer.innerHTML = ''; return; } 
                const mentorshipBadge = user.role === 'Alumni' ? `<div class="mt-2">${utils.getMentorshipBadge(user.mentorshipRequests || 0)}</div>` : '';
                let detailsHtml = '';
                const iconLink = (href, svg, text) => href ? `<a href="${href}" target="_blank" rel="noopener noreferrer" class="flex items-center gap-2 bg-gray-100 hover:bg-gray-200 text-gray-700 font-semibold py-2 px-4 rounded-lg transition-colors">${svg}<span>${text}</span></a>` : '';
                const mailSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-envelope-fill" viewBox="0 0 16 16"><path d="M.05 3.555A2 2 0 0 1 2 2h12a2 2 0 0 1 1.95 1.555L8 8.414.05 3.555zM0 4.697v7.104l5.803-3.558L0 4.697zM6.761 8.83l-6.57 4.027A2 2 0 0 0 2 14h12a2 2 0 0 0 1.808-1.144l-6.57-4.027L8 9.586l-1.239-.757zm3.436-.586L16 11.803V4.697l-5.803 3.558z"/></svg>`;
                const linkedinSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-linkedin" viewBox="0 0 16 16"><path d="M0 1.146C0 .513.526 0 1.175 0h13.65C15.474 0 16 .513 16 1.146v13.708c0 .633-.526 1.146-1.175 1.146H1.175C.526 16 0 15.487 0 14.854V1.146zm4.943 12.248V6.169H2.542v7.225h2.401zm-1.2-8.212c.837 0 1.358-.554 1.358-1.248-.015-.709-.52-1.248-1.342-1.248-.822 0-1.359.54-1.359 1.248 0 .694.521 1.248 1.327 1.248h.016zm4.908 8.212V9.359c0-.216.016-.432.08-.586.173-.431.568-.878 1.232-.878.869 0 1.216.662 1.216 1.634v3.865h2.401V9.25c0-2.22-1.184-3.252-2.764-3.252-1.274 0-1.845.7-2.165 1.193v.025h-.016a5.54 5.54 0 0 1 .016-.025V6.169h-2.4c.03.678 0 7.225 0 7.225h2.4z"/></svg>`;
                const githubSvg = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-github" viewBox="0 0 16 16"><path d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg>`;
                if (user.role === 'Recruiter') {
                    detailsHtml = `<h3 class="font-semibold border-b pb-1">Organization</h3><p class="text-gray-700">${user.organizationName || 'Not specified.'}</p>`;
                } else {
                    const experienceYears = user.yearOfJoining ? new Date().getFullYear() - user.yearOfJoining : 0;
                    const experienceText = user.yearOfJoining ? `${experienceYears} year(s)` : 'Fresher';
                    const academicInfo = user.faculty ? `<h3 class="font-semibold border-b pb-1">Academics</h3><p class="text-gray-700">${user.course || ''}<br><span class="text-sm text-gray-500">${user.faculty} (${user.startYear} - ${user.endYear})</span></p>` : '';
                    detailsHtml = `${academicInfo}<h3 class="font-semibold border-b pb-1">Experience</h3><p class="text-gray-700">${experienceText}</p><h3 class="font-semibold border-b pb-1">Skills</h3><p class="text-gray-700">${(user.skills || []).join(', ') || 'Not specified.'}</p>`;
                }
                dom.modalContainer.innerHTML = `<div class="modal-backdrop" id="profile-modal-backdrop"><div class="modal-content relative transition-all duration-300"><button id="close-modal-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button><div class="flex flex-col sm:flex-row items-center gap-6 mb-6"><img src="${utils.getProfileImageUrl(user)}" class="w-24 h-24 rounded-full flex-shrink-0 object-cover shadow-lg"><div class="text-center sm:text-left"><h2 class="text-2xl font-bold">${user.displayName}</h2><p class="text-gray-600">${user.headline || user.role}</p>${mentorshipBadge}<div class="flex justify-center sm:justify-start flex-wrap gap-3 mt-4">${iconLink(`mailto:${user.email}`, mailSvg, 'Email')}${iconLink(user.linkedin, linkedinSvg, 'LinkedIn')}${iconLink(user.github, githubSvg, 'GitHub')}</div></div></div><div class="space-y-4 text-sm">${detailsHtml}</div></div></div>`;
            },
            postJobModal: () => { dom.modalContainer.innerHTML = `<div class="modal-backdrop" id="post-job-modal-backdrop"><div class="modal-content relative"><button id="close-modal-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button><h2 class="text-2xl font-bold mb-4">Post a New Job</h2><form id="post-job-form" class="space-y-4"><div><label class="block text-sm font-medium">Job Title <span class="text-red-500">*</span></label><input id="job-title" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><div><label class="block text-sm font-medium">Location <span class="text-red-500">*</span></label><input id="job-location" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" placeholder="e.g., Agra, India or Remote"></div><div><label class="block text-sm font-medium">Job Description <span class="text-red-500">*</span></label><textarea id="job-description" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field" rows="5"></textarea></div><div><label class="block text-sm font-medium">Application Link or Email <span class="text-red-500">*</span></label><input id="job-link" type="text" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Post Job</button></form></div></div>`; },
            forgotPasswordModal: () => { dom.modalContainer.innerHTML = `<div class="modal-backdrop" id="forgot-password-modal-backdrop"><div class="modal-content relative"><button id="close-modal-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button><h2 class="text-2xl font-bold mb-4">Reset Password</h2><p class="text-sm text-gray-600 mb-4">Enter your email address and we will send you a link to reset your password.</p><form id="forgot-password-form" class="space-y-4"><div><label class="block text-sm font-medium">Email Address <span class="text-red-500">*</span></label><input id="forgot-email" type="email" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Send Reset Link</button></form></div></div>`; },
            reauthModal: () => { dom.modalContainer.innerHTML = `<div class="modal-backdrop" id="reauth-modal-backdrop"><div class="modal-content relative"><button id="close-modal-btn" class="absolute top-2 right-4 text-gray-500 hover:text-gray-800 text-3xl">&times;</button><h2 class="text-2xl font-bold mb-4">Confirm Your Password</h2><p class="text-sm text-gray-600 mb-4">For your security, please re-enter your password to delete your profile.</p><form id="reauth-form" class="space-y-4"><div><label class="block text-sm font-medium">Password <span class="text-red-500">*</span></label><input id="reauth-password" type="password" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md input-field"></div><button type="submit" class="w-full py-3 px-4 text-white font-medium rounded-md btn-primary">Confirm and Delete</button></form></div></div>`; },
            alumniDataPage: () => { const currentYear = new Date().getFullYear(); const years = Array.from({ length: 10 }, (_, i) => currentYear - i); return `<div class="page max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8"><h1 class="text-3xl font-bold text-gray-900">Alumni Data</h1><p class="text-gray-600 mb-6">Select a year to view and download alumni data.</p><div class="flex flex-col sm:flex-row gap-4 mb-6"><select id="year-select" class="input-field p-2 border rounded-md"><option value="">Select Year</option>${years.map(y => `<option value="${y}">${y}</option>`).join('')}</select><input id="alumni-search" type="text" placeholder="Search in table..." class="input-field p-2 border rounded-md flex-grow"><button id="download-alumni-xls" class="btn-primary text-white px-4 py-2 rounded-md">Download XLSX</button></div><div id="alumni-data-container" class="bg-white p-4 rounded-lg shadow overflow-x-auto"><p class="text-gray-500">Please select a year to display data.</p></div></div>`; },
            alumniDataTable: (data) => { const container = document.getElementById('alumni-data-container'); if (!container) return; if (data.length === 0) { container.innerHTML = '<p class="text-gray-500">No data found for this year or search query.</p>'; return; } const headers = Object.keys(data[0]); container.innerHTML = `<table id="alumni-data-table" class="w-full text-sm"><thead><tr class="bg-gray-50 border-b">${headers.map(h => `<th>${h}</th>`).join('')}</tr></thead><tbody>${data.map(row => `<tr>${headers.map(h => `<td>${row[h] || ''}</td>`).join('')}</tr>`).join('')}</tbody></table>`; },
            saarthiPage: () => {
                const mentors = state.users.filter(u => u.role === 'Alumni' && u.openToMentorship);
                const mentorCards = mentors.length > 0 ? mentors.map(mentor => `
                    <div class="card p-5">
                        <div class="flex items-center space-x-4">
                            <img src="${utils.getProfileImageUrl(mentor)}" class="w-20 h-20 rounded-full flex-shrink-0 object-cover">
                            <div class="flex-1">
                                <div class="flex justify-between items-start">
                                    <div>
                                        <h3 class="text-xl font-bold">${mentor.displayName}</h3>
                                        <p class="text-sm text-gray-600">${mentor.headline || 'Alumni'}</p>
                                    </div>
                                    <div class="text-right">${utils.getMentorshipBadge(mentor.mentorshipRequests || 0)}</div>
                                </div>
                                <div class="mt-2 flex flex-wrap gap-1">
                                    ${(mentor.skills || []).slice(0, 4).map(skill => `<span class="bg-teal-100 text-teal-700 text-xs font-medium px-2 py-1 rounded-full">${skill}</span>`).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="mt-4 flex gap-4">
                            <a href="mailto:${mentor.email}?subject=Mentorship Request from a DEI Student&body=Dear ${mentor.displayName},%0D%0A%0D%0AMy name is ${state.userData.displayName}, and I am a current student at DEI. I found your profile on the AlmaLink Saarthi platform and I would be grateful for your mentorship.%0D%0A%0D%0A[Your specific questions or area where you need help]%0D%0A%0D%0AThank you for your time and consideration.%0D%0A%0D%0ABest regards,%0D%0A${state.userData.displayName}" 
                               class="request-mentor-btn flex-1 text-center btn-primary text-white px-4 py-2 rounded-md" 
                               data-mentor-id="${mentor.id}" data-type="email">
                               Email for Mentorship
                            </a>
                            ${mentor.linkedin ? `<a href="${mentor.linkedin}" target="_blank" rel="noopener noreferrer" class="request-mentor-btn flex-1 text-center bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md" data-mentor-id="${mentor.id}" data-type="linkedin">Connect on LinkedIn</a>` : ''}
                        </div>
                    </div>
                `).join('') : '<p class="text-gray-500 col-span-full text-center">No alumni are currently open to mentorship. Check back soon!</p>';

                return `<div class="page max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
                            <h1 class="text-3xl font-bold text-gray-900">Saarthi Mentorship</h1>
                            <p class="text-gray-600">Connect with experienced alumni who are ready to guide you.</p>
                            <div class="mt-8 grid grid-cols-1 lg:grid-cols-2 gap-6">${mentorCards}</div>
                        </div>`;
            },
            maargdarshakAiPage: () => { 
                let historyHtml = state.maargdarshakHistory.map(msg => `<div class="flex ${msg.role === 'user' ? 'justify-end' : 'justify-start'}"><div class="max-w-lg p-3 rounded-lg ${msg.role === 'user' ? 'chat-bubble-user' : 'chat-bubble-model'}">${msg.parts[0].text}</div></div>`).join(''); 
                if (state.isAiResponding) { historyHtml += `<div class="flex justify-start"><div class="max-w-lg p-3 rounded-lg chat-bubble-model"><div class="typing-indicator"><span></span><span></span><span></span></div></div></div>`; } 
                return `<div class="page max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8 flex flex-col h-[calc(100vh-64px)] maargdarshak-bg rounded-lg shadow-inner"><div class="flex-shrink-0 text-white bg-teal-800/50 p-4 rounded-t-lg backdrop-blur-sm"><h1 class="text-3xl font-bold">Maargdarshak</h1><p>Your personal AI career counselor for technical and interview guidance.</p></div><div id="maargdarshak-chat-history" class="flex-grow bg-white/80 backdrop-blur-sm p-4 overflow-y-auto mb-4 space-y-4">${historyHtml}</div><form id="maargdarshak-form" class="flex-shrink-0 flex gap-4 p-4 bg-white/80 backdrop-blur-sm rounded-b-lg"><input id="maargdarshak-input" type="text" placeholder="Ask about a technical concept..." required class="flex-grow px-4 py-2 border rounded-lg input-field"><button type="submit" class="btn-primary text-white px-6 py-2 rounded-lg">Send</button></form></div>`; 
            },
            app: () => { 
                if (state.currentPage === 'loading') { dom.appLoader.style.display = 'flex'; dom.appContainer.innerHTML = ''; return; } else { dom.appLoader.style.display = 'none'; } 
                let pageContent = ''; 
                switch (state.currentPage) { 
                    case 'login': pageContent = render.authPage(true); break; 
                    case 'signup': pageContent = render.authPage(false); break; 
                    case 'selectRole': pageContent = render.roleSelectionPage(); break; 
                    case 'createProfile': pageContent = render.studentAlumniProfileCreationPage(); break; 
                    case 'createRecruiterProfile': pageContent = render.recruiterProfileCreationPage(); break; 
                    case 'dashboard': pageContent = render.navbar() + render.dashboard(); break; 
                    case 'profile': pageContent = render.navbar() + render.profilePage(); break; 
                    case 'chat': pageContent = render.navbar() + render.chatPage(); break; 
                    case 'jobs': pageContent = render.navbar() + render.jobBoardPage(); break; 
                    case 'admin': pageContent = render.navbar() + render.adminPage(); break; 
                    case 'alumniData': pageContent = render.navbar() + render.alumniDataPage(); break; 
                    case 'saarthi': pageContent = render.navbar() + render.saarthiPage(); break;
                    case 'maargdarshakAi': pageContent = render.navbar() + render.maargdarshakAiPage(); break;
                    default: pageContent = render.authPage(true); 
                } 
                dom.appContainer.innerHTML = pageContent; 
                if (state.viewingProfile) render.userProfileModal(state.viewingProfile); else dom.modalContainer.innerHTML = ''; 
                addEventListeners(); 
                if (state.currentPage === 'chat') document.getElementById('chat-box').scrollTop = document.getElementById('chat-box').scrollHeight; 
                if (state.currentPage === 'maargdarshakAi') document.getElementById('maargdarshak-chat-history').scrollTop = document.getElementById('maargdarshak-chat-history').scrollHeight; 
            }
        };

        const handlers = {
            authAction: async (e, isLogin) => { e.preventDefault(); const email = document.getElementById(`${isLogin ? 'login' : 'signup'}-email`).value; const password = document.getElementById(`${isLogin ? 'login' : 'signup'}-password`).value; try { if (isLogin) await signInWithEmailAndPassword(auth, email, password); else await createUserWithEmailAndPassword(auth, email, password); utils.showToast(`Logged in successfully!`); } catch (error) { utils.showToast(error.message, 'error'); } },
            logout: async () => { await signOut(auth); window.location.reload(); },
            roleSelection: async (e) => { const role = e.target.dataset.role; await setDoc(doc(db, `artifacts/${appId}/users/${state.currentUser.uid}`), { role }, { merge: true }); state.userData.role = role; state.currentPage = role === 'Recruiter' ? 'createRecruiterProfile' : 'createProfile'; render.app(); },
            profileCreate: async (e) => { 
                e.preventDefault(); 
                const startYear = parseInt(document.getElementById('profile-start-year').value); 
                const endYear = parseInt(document.getElementById('profile-end-year').value); 
                if (startYear >= endYear) { utils.showToast("End year must be after start year.", "error"); return; }
                const openToMentorship = state.userData.role === 'Alumni' ? document.getElementById('open-to-mentorship').checked : false;
                const userData = { 
                    displayName: document.getElementById('profile-name').value, 
                    gender: document.querySelector('input[name="gender"]:checked').value, 
                    faculty: document.getElementById('profile-faculty').value, 
                    course: document.getElementById('profile-course').value, 
                    startYear: startYear, 
                    endYear: endYear, 
                    headline: document.getElementById('profile-headline').value, 
                    yearOfJoining: document.getElementById('fresher-checkbox').checked ? null : document.getElementById('profile-joining-year').value, 
                    skills: document.getElementById('profile-skills').value.split(',').map(s => s.trim()).filter(Boolean), 
                    linkedin: document.getElementById('profile-linkedin').value, 
                    github: document.getElementById('profile-github').value, 
                    email: state.currentUser.email,
                    openToMentorship: openToMentorship,
                    mentorshipRequests: 0,
                    mentoredBy: null,
                }; 
                await setDoc(doc(db, `artifacts/${appId}/users/${state.currentUser.uid}`), userData, { merge: true }); 
                state.userData = { ...state.userData, ...userData }; 
                state.currentPage = 'dashboard'; 
                render.app(); 
                utils.showToast('Profile created!'); 
            },
            profileUpdate: async (e) => {
                e.preventDefault();
                let updatedData;
                if (state.userData.role === 'Recruiter' || state.userData.role === 'Admin') {
                    updatedData = {
                        displayName: document.getElementById('profile-name-update').value,
                        headline: document.getElementById('profile-headline-update').value,
                        organizationName: document.getElementById('profile-organization-update').value,
                        website: document.getElementById('profile-website-update').value
                    };
                } else {
                    const startYear = parseInt(document.getElementById('profile-start-year-update').value);
                    const endYear = parseInt(document.getElementById('profile-end-year-update').value);
                    if (startYear >= endYear) {
                        utils.showToast("End year must be after start year.", "error");
                        return;
                    }
                    const openToMentorship = state.userData.role === 'Alumni' ? document.getElementById('open-to-mentorship-update').checked : state.userData.openToMentorship;
            
                    updatedData = {
                        displayName: document.getElementById('profile-name-update').value,
                        headline: document.getElementById('profile-headline-update').value,
                        faculty: document.getElementById('profile-faculty-update').value,
                        course: document.getElementById('profile-course-update').value,
                        startYear: startYear,
                        endYear: endYear,
                        yearOfJoining: document.getElementById('profile-joining-year-update').value,
                        skills: document.getElementById('profile-skills-update').value.split(',').map(s => s.trim()).filter(Boolean),
                        linkedin: document.getElementById('profile-linkedin-update').value,
                        github: document.getElementById('profile-github-update').value,
                        openToMentorship: openToMentorship,
                    };
                }
                
                await setDoc(doc(db, `artifacts/${appId}/users/${state.currentUser.uid}`), updatedData, { merge: true });
                state.userData = { ...state.userData, ...updatedData };
                utils.showToast('Profile updated!');
                state.currentPage = 'dashboard';
                render.app();
            },
            requestMentorship: async (e) => {
                const mentorId = e.target.dataset.mentorId;
                const type = e.target.dataset.type;

                if (mentorId) {
                    const mentorRef = doc(db, `artifacts/${appId}/users`, mentorId);
                    await updateDoc(mentorRef, {
                        mentorshipRequests: increment(1)
                    });

                    const studentRef = doc(db, `artifacts/${appId}/users`, state.currentUser.uid);
                    await updateDoc(studentRef, {
                        mentoredBy: mentorId
                    });
                    
                    if(type === 'email'){
                        utils.showToast("Opening email client...", "success");
                    } else {
                        utils.showToast("Redirecting to LinkedIn...", "success");
                    }
                }
            },
             callMaargdarshakAi: async (e) => {
                e.preventDefault();
                const input = document.getElementById('maargdarshak-input');
                const userQuery = input.value.trim();
                const apiKey = GEMINI_API_KEY;
                if (!apiKey || apiKey === "YOUR_GEMINI_API_KEY") { utils.showToast('API key is not set. Please add it in the code.', 'error'); return; }
                if (!userQuery || state.isAiResponding) return;

                state.isAiResponding = true;
                state.maargdarshakHistory.push({ role: 'user', parts: [{ text: userQuery }] });
                input.value = '';
                input.disabled = true;
                render.app();

                const historyForApi = state.maargdarshakHistory.map(h => ({ role: h.role, parts: h.parts }));
                const userName = state.userData?.displayName || 'student';
                const userSkills = (state.userData?.skills || []).join(', ') || 'not specified';
                const systemPrompt = `You are Maargdarshak, a friendly and expert career counselor for students and alumni of the Dayalbagh Educational Institute (DEI), Agra. Your goal is to provide encouraging, insightful, and practical advice on technical topics, industry trends, and interview preparation. You are currently mentoring ${userName}, whose skills include: ${userSkills}. Tailor your advice to their skillset when appropriate. Be supportive and act as a mentor. Format your answers clearly: use bullet points (using a '-' character) for lists, and use bold markdown for emphasis on key terms (e.g., **Key Term**). Do not use any other markdown like asterisks for bullet points.`;

                try {
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const payload = { contents: historyForApi, systemInstruction: { parts: [{ text: systemPrompt }] } };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) { throw new Error(`API Error: ${response.statusText}`); }
                    const result = await response.json();
                    let modelResponse = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (modelResponse) {
                        let formattedResponse = modelResponse
                            .replace(/\*\*(.*?)\*\*/g, '<b>$1</b>')
                            .replace(/^\s*-\s(.*)/gm, '<p class="ml-4">&bull; $1</p>')
                            .replace(/(\r\n|\n|\r)/gm, '<br>')
                            .replace(/<br><p/g, '<p')
                            .replace(/<\/p><br>/g, '</p>');
                        state.maargdarshakHistory.push({ role: 'model', parts: [{ text: formattedResponse }] });
                    } else { throw new Error('Invalid response structure from API.'); }
                } catch (error) {
                    state.maargdarshakHistory.push({ role: 'model', parts: [{ text: `Sorry, I encountered an error: ${error.message}. Please check your API key and network.` }] });
                    utils.showToast(error.message, 'error');
                } finally {
                    state.isAiResponding = false;
                    input.disabled = false;
                    render.app();
                    input.focus();
                    if (state.currentUser) {
                        const historyRef = doc(db, `artifacts/${appId}/users/${state.currentUser.uid}/maargdarshakHistory/main`);
                        await setDoc(historyRef, { messages: state.maargdarshakHistory });
                    }
                }
            },
            // ... (other handlers like viewProfile, search, sendMessage, etc. would go here)
        };

        const addEventListeners = () => {
            document.getElementById('login-form')?.addEventListener('submit', (e) => handlers.authAction(e, true));
            document.getElementById('signup-form')?.addEventListener('submit', (e) => handlers.authAction(e, false));
            document.getElementById('show-signup')?.addEventListener('click', () => { state.currentPage = 'signup'; render.app(); });
            document.getElementById('show-login')?.addEventListener('click', () => { state.currentPage = 'login'; render.app(); });
            document.querySelectorAll('.role-btn').forEach(btn => btn.addEventListener('click', handlers.roleSelection));
            document.getElementById('profile-form')?.addEventListener('submit', handlers.profileCreate);
            document.getElementById('profile-update-form')?.addEventListener('submit', handlers.profileUpdate);
            document.getElementById('profile-form')?.querySelector('#profile-faculty')?.addEventListener('change', (e) => utils.populateCourses(e.target.value, 'profile-course'));
            const facultyUpdateEl = document.getElementById('profile-faculty-update');
            if(facultyUpdateEl){
                 facultyUpdateEl.addEventListener('change', (e) => utils.populateCourses(e.target.value, 'profile-course-update'));
                 if (state.userData && state.userData.faculty) {
                    utils.populateCourses(state.userData.faculty, 'profile-course-update', state.userData.course);
                 }
            }
            document.getElementById('logout-btn')?.addEventListener('click', handlers.logout);
            document.getElementById('logout-btn-mobile')?.addEventListener('click', handlers.logout);
            document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => { state.currentPage = e.target.dataset.page; render.app(); }));
            document.querySelectorAll('.nav-link-mobile').forEach(link => { link.addEventListener('click', (e) => { document.getElementById('mobile-menu').classList.add('hidden'); state.currentPage = e.target.dataset.page; render.app(); }); });
            document.getElementById('mobile-menu-btn')?.addEventListener('click', () => { document.getElementById('mobile-menu').classList.toggle('hidden'); });
            document.querySelectorAll('.request-mentor-btn').forEach(btn => btn.addEventListener('click', handlers.requestMentorship));
            document.getElementById('maargdarshak-form')?.addEventListener('submit', handlers.callMaargdarshakAi);
        };

        const listenToUsers = () => onSnapshot(query(collection(db, `artifacts/${appId}/users`)), (snapshot) => { state.users = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); state.isDataLoading = false; if (['dashboard', 'chat', 'admin', 'saarthi'].includes(state.currentPage) || state.userData?.role === 'Recruiter') render.app(); });
        const listenToChat = () => { const q = query(collection(db, `artifacts/${appId}/chats`), orderBy("timestamp", "asc")); onSnapshot(q, (snapshot) => { state.chatMessages = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (state.currentPage === 'chat' || state.currentPage === 'admin') render.app(); }); };
        const listenToJobs = () => { const q = query(collection(db, `artifacts/${appId}/jobs`), orderBy("timestamp", "desc")); onSnapshot(q, (snapshot) => { state.jobs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (state.currentPage === 'jobs' || state.currentPage === 'admin' || (state.userData?.role === 'Recruiter' && state.currentPage === 'dashboard')) render.app(); }); }
        const listenToEvents = () => { const q = query(collection(db, `artifacts/${appId}/events`), orderBy("timestamp", "desc")); onSnapshot(q, (snapshot) => { state.events = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); if (state.currentPage === 'dashboard' || state.currentPage === 'admin') render.app(); }); };
        const listenToMaargdarshakHistory = () => { if (!state.currentUser) return; const historyRef = doc(db, `artifacts/${appId}/users`, state.currentUser.uid, 'maargdarshakHistory', 'main'); onSnapshot(historyRef, (docSnap) => { if (docSnap.exists() && docSnap.data().messages) { state.maargdarshakHistory = docSnap.data().messages; } else { state.maargdarshakHistory = []; } if (state.currentPage === 'maargdarshakAi') { render.app(); } }); };

        let quoteIndex = 0;
        const cycleQuotes = () => { if (dom.loaderQuote) { dom.loaderQuote.textContent = quotes[quoteIndex]; quoteIndex = (quoteIndex + 1) % quotes.length; } };
        cycleQuotes(); setInterval(cycleQuotes, 8000);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                state.currentUser = user;
                state.isAdmin = adminEmails.includes(user.email);
                const userDoc = await getDoc(doc(db, `artifacts/${appId}/users/${user.uid}`));
                if (userDoc.exists()) {
                    state.userData = userDoc.data();
                    if (state.isAdmin && state.userData.role !== 'Admin') { await updateDoc(doc(db, `artifacts/${appId}/users/${user.uid}`), { role: 'Admin' }); state.userData.role = 'Admin'; }
                    if (!state.userData.role) state.currentPage = 'selectRole';
                    else if (!state.userData.displayName) { if (state.isAdmin) state.userData.role = 'Admin'; state.currentPage = (state.userData.role === 'Recruiter' || state.userData.role === 'Admin') ? 'createRecruiterProfile' : 'createProfile'; }
                    else state.currentPage = 'dashboard';
                } else { state.userData = {}; state.currentPage = 'selectRole'; }
                listenToUsers();
                listenToChat();
                listenToJobs();
                listenToEvents(); 
                listenToMaargdarshakHistory();
            } else { state.currentUser = null; state.userData = null; state.isAdmin = false; state.currentPage = 'login'; state.isDataLoading = false; }
            render.app();
        });
    </script>
</body>
</html>
